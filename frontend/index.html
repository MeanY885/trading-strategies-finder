<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTCGBP ML Optimizer</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --accent-glow: rgba(139, 92, 246, 0.3);
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --border: #27272a;
            --border-subtle: #1f1f23;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 3rem 0;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 2rem;
        }
        
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .card-header .icon {
            width: 40px;
            height: 40px;
            background: var(--accent-glow);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), #7c3aed);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-badge.success {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .status-badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .status-badge.danger {
            background: var(--danger-bg);
            color: var(--danger);
        }
        
        .status-badge.neutral {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        
        /* Progress Bar */
        .progress-container {
            margin: 1.5rem 0;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-value.positive { color: var(--success); }
        .stat-value.negative { color: var(--danger); }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Input */
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        /* Code Block */
        .code-block {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }
        
        /* Logs */
        .log-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: var(--text-muted);
            margin-right: 0.5rem;
        }
        
        /* Full width card */
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* Actions row */
        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--bg-hover);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Pulsing activity indicator */
        .pulse-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Active optimization card glow */
        .card.active-optimization {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        
        /* Parameters Table */
        .params-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .params-table th, .params-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .params-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .params-table td {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Info box */
        .info-box {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .info-box strong {
            color: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trading Strategy Optimizer</h1>
            <p>Find profitable strategies automatically. Get TradingView-ready code.</p>
        </header>
        
        <div class="grid">
            <!-- Data Section -->
            <div class="card">
                <div class="card-header">
                    <div class="icon">üìä</div>
                    <h2>Data</h2>
                </div>
                
                <div id="dataStatus">
                    <span class="status-badge neutral">No data loaded</span>
                </div>
                
                <div class="input-group" style="margin-top: 1rem;">
                    <label>Data Source</label>
                    <select id="sourceSelect" onchange="updatePairOptions()">
                        <option value="yfinance" selected>Yahoo Finance</option>
                        <option value="binance">Binance</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Trading Pair</label>
                    <select id="pairSelect">
                        <option value="BTC-GBP" selected>BTC/GBP</option>
                        <option value="ETH-GBP">ETH/GBP</option>
                        <option value="BTC-EUR">BTC/EUR</option>
                        <option value="ETH-EUR">ETH/EUR</option>
                        <option value="BTC-USD">BTC/USD</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Historical Period</label>
                    <select id="monthsSelect">
                        <option value="0.03">1 day</option>
                        <option value="0.25">1 week</option>
                        <option value="1">1 month</option>
                        <option value="3" selected>3 months</option>
                        <option value="6">6 months</option>
                        <option value="12">12 months</option>
                        <option value="24">24 months</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Timeframe</label>
                    <select id="intervalSelect">
                        <option value="15" selected>15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="240">4 hours</option>
                    </select>
                </div>
                
                
                <div class="actions">
                    <button class="btn btn-primary" id="fetchDataBtn" onclick="fetchData()">
                        Fetch Data
                    </button>
                    <button class="btn btn-secondary" onclick="loadExistingData()">
                        Load Existing
                    </button>
                </div>
                
                <!-- Data Loading Progress -->
                <div id="dataLoadingProgress" style="display: none; margin-top: 1rem;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="dataProgressFill" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span id="dataProgressMessage" style="color: var(--text-secondary); font-size: 0.9rem;">Loading...</span>
                        <span id="dataProgressPercent" style="color: var(--accent-primary); font-weight: 500;"></span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <label style="color: var(--accent-secondary); font-weight: 500;">üìä TradingView Premium Export (Recommended)</label>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0.5rem 0;">Export chart data from TradingView (Right-click ‚Üí Export chart data)</p>
                    <input type="file" id="csvUpload" accept=".csv" onchange="uploadCSV(event)" style="display: none;">
                    <button class="btn btn-success" id="uploadCsvBtn" onclick="document.getElementById('csvUpload').click()" style="margin-top: 0.5rem;">
                        üìÅ Upload TradingView CSV
                    </button>
                </div>
            </div>

            <!-- Backtest Date Range Section -->
            <div class="card" id="backtestDateCard">
                <div class="card-header">
                    <div class="icon">üìÖ</div>
                    <h2>Backtest Date Range</h2>
                </div>

                <div class="input-group" style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="enableDateRange" checked style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                        <span>Backtest Entries to Date Range</span>
                    </label>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">When enabled, Pine Script will only execute trades within this date range</p>
                </div>

                <div id="dateRangeInputs">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>Start</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="date" id="backtestStartDate" style="flex: 2;">
                                <input type="time" id="backtestStartTime" value="00:00" style="flex: 1;">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>End</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="date" id="backtestEndDate" style="flex: 2;">
                                <input type="time" id="backtestEndTime" value="23:59" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 1rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);">
                    <strong>Tip:</strong> Dates auto-populate from loaded data. Adjust to test specific periods (e.g., exclude first months for indicator warmup, or test specific market conditions).
                </div>

                <!-- Data Statistics -->
                <div id="dataStatsSection" style="display: none; margin-top: 1rem;">
                    <!-- Row 1: Min, Avg, Max Price -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Min Price</div>
                            <div id="statMinPrice" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-danger);">-</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Avg Price</div>
                            <div id="statAvgPrice" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-primary);">-</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Max Price</div>
                            <div id="statMaxPrice" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-success);">-</div>
                        </div>
                    </div>
                    <!-- Row 2: Down Swing, Volatility, Up Swing -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 0.75rem;">
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Largest Down Swing</div>
                            <div id="statMaxDown" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-danger);">-</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Volatility (ATR%)</div>
                            <div id="statVolatility" style="font-size: 1.1rem; font-weight: 600; color: #fbbf24;">-</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Largest Up Swing</div>
                            <div id="statMaxUp" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-success);">-</div>
                        </div>
                    </div>
                    <!-- Row 3: Daily Bull/Bear Timeline -->
                    <div style="margin-top: 0.75rem; background: rgba(30, 30, 40, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.75rem;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Daily Trend Timeline</div>
                        <div id="dailyTrendTimeline" style="display: flex; gap: 2px; flex-wrap: wrap; min-height: 24px;">
                            <!-- Filled by JS -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted);">
                            <span id="timelineStartDate">-</span>
                            <span style="display: flex; gap: 1rem;">
                                <span>üü¢ Bull</span>
                                <span>üî¥ Bear</span>
                                <span>‚ö™ Flat</span>
                            </span>
                            <span id="timelineEndDate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UNIFIED OPTIMIZATION - THE Main Feature -->
            <div class="card full-width" id="unifiedCard" style="position: relative; border: 2px solid var(--accent-primary);">
                <div id="unifiedOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,15,0.85); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: 12px;">
                    <div style="text-align: center; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîí</div>
                        <div>Load data first to start</div>
                    </div>
                </div>

                <div class="card-header">
                    <div class="icon" style="background: linear-gradient(135deg, var(--accent-primary), #ec4899);">üéØ</div>
                    <h2>Find Profitable Strategies <span id="strategyDateRange" style="font-size: 0.85rem; font-weight: normal; color: var(--text-muted);"></span></h2>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(139, 92, 246, 0.4);">
                    <strong>How it works:</strong> Tests <strong>39 entry strategies</strong> (RSI, Bollinger Bands, MACD, Ichimoku, Keltner, Donchian, Aroon, etc.) with both long and short directions. Optimizes <strong>TP/SL percentages</strong> (0.1% - 10%). Native engine also supports candlestick pattern recognition.
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0;">
                    <div class="input-group">
                        <label>Starting Capital (¬£)</label>
                        <input type="number" id="unifiedCapital" value="1000" min="100" max="100000" step="100">
                    </div>
                    <div class="input-group">
                        <label>Position Size (% of equity)</label>
                        <input type="number" id="unifiedRisk" value="75" min="1" max="100" step="5">
                    </div>
                    <div class="input-group">
                        <label>TP/SL Granularity</label>
                        <select id="unifiedTrials">
                            <option value="100">1.0% steps (fast)</option>
                            <option value="225">0.67% steps (balanced)</option>
                            <option value="400" selected>0.5% steps (thorough)</option>
                            <option value="625">0.4% steps (fine)</option>
                            <option value="10000">0.1% steps (exhaustive)</option>
                        </select>
                    </div>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); margin-top: 0.5rem;">
                    <strong>üî¨ Dual-Engine:</strong> TradingView engine for Pine Script export, Native engine (TA-Lib) for fast in-app execution with candlestick patterns.
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="unifiedBtn" onclick="runUnifiedOptimization()" style="background: linear-gradient(135deg, var(--accent-primary), #ec4899); font-size: 1.1rem; padding: 1rem 2rem; width: 100%;">
                        Find Best Strategies
                    </button>
                </div>
                
                <div id="unifiedProgress" style="display: none; margin-top: 1.5rem;">
                    <div class="progress-bar" style="height: 12px;">
                        <div class="progress-fill" id="unifiedProgressFill" style="width: 0%; background: linear-gradient(90deg, var(--accent-primary), #ec4899);"></div>
                    </div>
                    <p id="unifiedMessage" style="color: var(--text-secondary); margin-top: 0.75rem; font-size: 0.95rem;"></p>
                </div>
                
                <div id="unifiedResults" style="margin-top: 1.5rem;"></div>
            </div>
            
            <!-- TradingView Comparison Section -->
            <div class="card full-width" id="comparisonCard" style="display: none;">
                <div class="card-header">
                    <div class="icon" style="background: linear-gradient(135deg, #2962FF, #00BCD4);">üìä</div>
                    <h2>TradingView vs Our System Comparison</h2>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(41, 98, 255, 0.1), rgba(0, 188, 212, 0.1)); border: 1px solid rgba(41, 98, 255, 0.3);">
                    <strong>How to compare:</strong>
                    1. Run our optimization on your data.
                    2. Copy the Pine Script to TradingView.
                    3. In TradingView Strategy Tester, click "List of Trades" ‚Üí Export (CSV icon).
                    4. Upload that CSV here to compare.
                </div>

                <div style="display: flex; gap: 1rem; align-items: center; margin: 1rem 0; flex-wrap: wrap;">
                    <div class="input-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                        <label>Compare against strategy:</label>
                        <select id="comparisonRankSelect">
                            <option value="1">#1 Strategy</option>
                            <option value="2">#2 Strategy</option>
                            <option value="3">#3 Strategy</option>
                            <option value="4">#4 Strategy</option>
                            <option value="5">#5 Strategy</option>
                        </select>
                    </div>
                    <div>
                        <input type="file" id="tvComparisonUpload" accept=".csv" onchange="uploadTVComparison(event)" style="display: none;">
                        <button class="btn" onclick="document.getElementById('tvComparisonUpload').click()" style="background: linear-gradient(135deg, #2962FF, #00BCD4); margin-top: 1.25rem;">
                            üìÅ Upload TradingView Trade Export
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="clearComparison()" style="margin-top: 1.25rem;">
                        Clear
                    </button>
                </div>

                <div id="comparisonResults"></div>
            </div>

            <!-- Activity Log -->
            <div class="card full-width">
                <div class="card-header">
                    <div class="icon">üìú</div>
                    <h2>Activity Log</h2>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-time">[00:00:00]</span>
                        System ready. Fetch data to begin.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let pollingInterval = null;
        
        // Utility functions
        function formatTime() {
            const now = new Date();
            return now.toTimeString().split(' ')[0];
        }
        
        function addLog(message) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${formatTime()}]</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function updateDataStatus(status) {
            const container = document.getElementById('dataStatus');
            const loadingProgress = document.getElementById('dataLoadingProgress');
            const unifiedOverlay = document.getElementById('unifiedOverlay');

            if (status.loaded) {
                // Data loaded - update status
                container.innerHTML = `
                    <span class="status-badge success">‚úì ${status.rows.toLocaleString()} candles loaded</span>
                    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                        ${formatDateUK(status.start_date)} ‚Üí ${formatDateUK(status.end_date)}
                    </p>
                `;

                // Hide loading progress
                loadingProgress.style.display = 'none';

                // Enable unified optimizer section
                if (unifiedOverlay) unifiedOverlay.style.display = 'none';

                // Show comparison card
                showComparisonCard();

                // Auto-populate backtest date range from loaded data
                updateBacktestDateRange(status.start_date, status.end_date);

                // Update data statistics
                if (status.stats) {
                    updateDataStats(status.stats);
                }

            } else if (status.message && status.message.includes('Fetching')) {
                // Data is being fetched - show loading progress
                container.innerHTML = `<span class="status-badge warning">üì• ${status.message}</span>`;
                loadingProgress.style.display = 'block';

                // Simulate progress (actual progress isn't tracked by backend for data fetch)
                animateDataLoading(status.message);

                // Keep overlay visible
                if (unifiedOverlay) unifiedOverlay.style.display = 'flex';

            } else {
                // No data loaded
                container.innerHTML = `<span class="status-badge danger">No data loaded</span>`;
                loadingProgress.style.display = 'none';

                // Show overlay
                if (unifiedOverlay) unifiedOverlay.style.display = 'flex';
            }
        }
        
        let dataLoadingAnimation = null;
        function animateDataLoading(message) {
            const fill = document.getElementById('dataProgressFill');
            const msgEl = document.getElementById('dataProgressMessage');
            const pctEl = document.getElementById('dataProgressPercent');
            
            msgEl.textContent = message;
            
            // Animate progress bar
            if (!dataLoadingAnimation) {
                let progress = 0;
                dataLoadingAnimation = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress > 90) progress = 90; // Cap at 90% until complete
                    fill.style.width = `${progress}%`;
                    pctEl.textContent = `${Math.round(progress)}%`;
                }, 500);
            }
        }
        
        function stopDataLoadingAnimation() {
            if (dataLoadingAnimation) {
                clearInterval(dataLoadingAnimation);
                dataLoadingAnimation = null;
            }
            const fill = document.getElementById('dataProgressFill');
            const pctEl = document.getElementById('dataProgressPercent');
            fill.style.width = '100%';
            pctEl.textContent = '100%';
        }

        // Format date to UK format DD/MM/YY
        function formatDateUK(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            return `${day}/${month}/${year}`;
        }

        // Update backtest date range inputs from loaded data
        function updateBacktestDateRange(startDate, endDate) {
            console.log('updateBacktestDateRange called with:', startDate, endDate);

            const startInput = document.getElementById('backtestStartDate');
            const endInput = document.getElementById('backtestEndDate');
            const strategyDateRange = document.getElementById('strategyDateRange');

            if (startDate && startInput) {
                const start = startDate.split('T')[0];
                console.log('Setting start date to:', start);
                startInput.value = start;
            }
            if (endDate && endInput) {
                const end = endDate.split('T')[0];
                console.log('Setting end date to:', end);
                endInput.value = end;
            }

            // Update the strategy heading with date range (UK format)
            if (strategyDateRange && startDate && endDate) {
                strategyDateRange.textContent = `for ${formatDateUK(startDate)} ‚Üí ${formatDateUK(endDate)}`;
            }
        }

        // Update data statistics display
        function updateDataStats(stats) {
            const statsSection = document.getElementById('dataStatsSection');
            if (!stats || !statsSection) return;

            statsSection.style.display = 'block';

            // Format currency based on pair (assume GBP for now)
            const formatPrice = (price) => {
                if (price >= 1000) {
                    return '¬£' + price.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                }
                return '¬£' + price.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            document.getElementById('statMinPrice').textContent = formatPrice(stats.min_price);
            document.getElementById('statAvgPrice').textContent = formatPrice(stats.avg_price);
            document.getElementById('statMaxPrice').textContent = formatPrice(stats.max_price);
            document.getElementById('statMaxUp').textContent = '+' + stats.max_up_swing.toFixed(2) + '%';
            document.getElementById('statMaxDown').textContent = stats.max_down_swing.toFixed(2) + '%';
            document.getElementById('statVolatility').textContent = stats.volatility_pct.toFixed(2) + '%';

            // Render daily trend timeline
            if (stats.daily_trends && stats.daily_trends.length > 0) {
                renderDailyTrendTimeline(stats.daily_trends);
            }
        }

        // Render the daily bull/bear timeline
        function renderDailyTrendTimeline(dailyTrends) {
            const container = document.getElementById('dailyTrendTimeline');
            const startLabel = document.getElementById('timelineStartDate');
            const endLabel = document.getElementById('timelineEndDate');

            if (!container || !dailyTrends || dailyTrends.length === 0) return;

            // Set date labels (UK format)
            startLabel.textContent = formatDateUK(dailyTrends[0].date);
            endLabel.textContent = formatDateUK(dailyTrends[dailyTrends.length - 1].date);

            const numDays = dailyTrends.length;

            // If more than 90 days, aggregate to weeks; if more than 365, aggregate to months
            let displayData = dailyTrends;
            let label = 'Daily';

            if (numDays > 365) {
                // Aggregate to months
                label = 'Monthly';
                const monthlyMap = {};
                dailyTrends.forEach(d => {
                    const month = d.date.substring(0, 7); // YYYY-MM
                    if (!monthlyMap[month]) monthlyMap[month] = { bull: 0, bear: 0, flat: 0 };
                    monthlyMap[month][d.trend]++;
                });
                displayData = Object.entries(monthlyMap).map(([month, counts]) => {
                    const dominant = counts.bull >= counts.bear ? (counts.bull > counts.flat ? 'bull' : 'flat') : (counts.bear > counts.flat ? 'bear' : 'flat');
                    return { date: month, trend: dominant, counts };
                });
            } else if (numDays > 90) {
                // Aggregate to weeks
                label = 'Weekly';
                const weeklyMap = {};
                dailyTrends.forEach(d => {
                    const date = new Date(d.date);
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    const weekKey = weekStart.toISOString().split('T')[0];
                    if (!weeklyMap[weekKey]) weeklyMap[weekKey] = { bull: 0, bear: 0, flat: 0 };
                    weeklyMap[weekKey][d.trend]++;
                });
                displayData = Object.entries(weeklyMap).map(([week, counts]) => {
                    const dominant = counts.bull >= counts.bear ? (counts.bull > counts.flat ? 'bull' : 'flat') : (counts.bear > counts.flat ? 'bear' : 'flat');
                    return { date: week, trend: dominant, counts };
                });
            }

            // Calculate bar width - ensure bars fill container
            const containerWidth = container.offsetWidth || 400;
            const barWidth = Math.max(4, Math.floor((containerWidth - (displayData.length * 2)) / displayData.length));

            // Build timeline HTML
            let html = '';
            displayData.forEach((day, index) => {
                let color, title;
                const dateFormatted = formatDateUK(day.date);
                if (day.trend === 'bull') {
                    color = '#10b981'; // green
                    title = `${dateFormatted}: Bull üìà`;
                } else if (day.trend === 'bear') {
                    color = '#ef4444'; // red
                    title = `${dateFormatted}: Bear üìâ`;
                } else {
                    color = 'rgba(255,255,255,0.4)';
                    title = `${dateFormatted}: Flat ‚û°Ô∏è`;
                }

                if (day.counts) {
                    title += ` (${day.counts.bull}‚Üë ${day.counts.bear}‚Üì ${day.counts.flat}‚Üí)`;
                }

                html += `<div style="width:${barWidth}px; height:24px; background:${color}; border-radius:2px; cursor:pointer;" title="${title}"></div>`;
            });

            container.innerHTML = html;

            // Update label
            const labelEl = container.parentElement.querySelector('div:first-child');
            if (labelEl) {
                labelEl.textContent = `${label} Trend Timeline (${numDays} days)`;
            }

            // Add summary below
            const bullDays = dailyTrends.filter(d => d.trend === 'bull').length;
            const bearDays = dailyTrends.filter(d => d.trend === 'bear').length;
            const flatDays = dailyTrends.filter(d => d.trend === 'flat').length;

            // Update the legend with counts
            const legendContainer = container.parentElement.querySelector('div:last-child span:nth-child(2)');
            if (legendContainer) {
                legendContainer.innerHTML = `
                    <span style="color:#10b981">‚óè Bull (${bullDays})</span>
                    <span style="color:#ef4444">‚óè Bear (${bearDays})</span>
                    <span style="color:rgba(255,255,255,0.6)">‚óè Flat (${flatDays})</span>
                `;
            }
        }

        // Get current backtest date range settings for Pine Script generation
        function getBacktestDateRange() {
            const enabled = document.getElementById('enableDateRange').checked;
            if (!enabled) return null;

            const startDate = document.getElementById('backtestStartDate').value;
            const startTime = document.getElementById('backtestStartTime').value || '00:00';
            const endDate = document.getElementById('backtestEndDate').value;
            const endTime = document.getElementById('backtestEndTime').value || '23:59';

            if (!startDate || !endDate) return null;

            return {
                enabled: true,
                startDate: startDate,
                startTime: startTime,
                endDate: endDate,
                endTime: endTime,
                // Format for Pine Script timestamp function
                startTimestamp: `${startDate} ${startTime}`,
                endTimestamp: `${endDate} ${endTime}`
            };
        }

        // Toggle date range inputs visibility
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('enableDateRange');
            const inputs = document.getElementById('dateRangeInputs');

            checkbox.addEventListener('change', function() {
                inputs.style.opacity = this.checked ? '1' : '0.5';
                inputs.style.pointerEvents = this.checked ? 'auto' : 'none';
            });
        });

        // Data source pair options
        const PAIR_OPTIONS = {
            yfinance: [
                { value: 'BTC-GBP', label: 'BTC/GBP' },
                { value: 'ETH-GBP', label: 'ETH/GBP' },
                { value: 'BTC-EUR', label: 'BTC/EUR' },
                { value: 'ETH-EUR', label: 'ETH/EUR' },
                { value: 'BTC-USD', label: 'BTC/USD' },
            ],
            binance: [
                { value: 'BTCUSDT', label: 'BTC/USDT' },
                { value: 'ETHUSDT', label: 'ETH/USDT' },
                { value: 'SOLUSDT', label: 'SOL/USDT' },
                { value: 'BNBUSDT', label: 'BNB/USDT' },
                { value: 'XRPUSDT', label: 'XRP/USDT' },
            ]
        };
        
        function updatePairOptions() {
            const source = document.getElementById('sourceSelect').value;
            const pairSelect = document.getElementById('pairSelect');
            
            // Update pairs based on source
            pairSelect.innerHTML = PAIR_OPTIONS[source].map(p => 
                `<option value="${p.value}">${p.label}</option>`
            ).join('');
        }
        
        // API Functions
        async function fetchData() {
            const source = document.getElementById('sourceSelect').value;
            const pair = document.getElementById('pairSelect').value;
            const months = document.getElementById('monthsSelect').value;
            const interval = document.getElementById('intervalSelect').value;
            const btn = document.getElementById('fetchDataBtn');
            const loadingProgress = document.getElementById('dataLoadingProgress');
            
            const sourceName = source === 'binance' ? 'Binance' : 'Yahoo Finance';
            
            // Show loading UI
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> Fetching...`;
            document.getElementById('uploadCsvBtn').disabled = true;
            
            // Show and reset progress
            loadingProgress.style.display = 'block';
            document.getElementById('dataProgressFill').style.width = '0%';
            document.getElementById('dataProgressMessage').textContent = `Connecting to ${sourceName}...`;
            document.getElementById('dataProgressPercent').textContent = '0%';
            
            // Start animation
            if (dataLoadingAnimation) clearInterval(dataLoadingAnimation);
            let progress = 0;
            dataLoadingAnimation = setInterval(() => {
                progress += Math.random() * 3;
                if (progress > 85) progress = 85;
                document.getElementById('dataProgressFill').style.width = `${progress}%`;
                document.getElementById('dataProgressPercent').textContent = `${Math.round(progress)}%`;
            }, 500);
            
            addLog(`Fetching ${months} months of ${interval}m ${pair} from ${sourceName}...`);
            
            try {
                const response = await fetch('/api/fetch-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, pair, interval: parseInt(interval), months: parseFloat(months) })
                });
                
                const data = await response.json();
                document.getElementById('dataProgressMessage').textContent = data.message;
                addLog(data.message);
                
                // Start fast polling for data fetch
                startFastPolling();
                
            } catch (error) {
                addLog(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = 'Fetch Data';
                document.getElementById('uploadCsvBtn').disabled = false;
                loadingProgress.style.display = 'none';
                stopDataLoadingAnimation();
            }
        }
        
        async function loadExistingData() {
            const btn = document.getElementById('fetchDataBtn');
            const loadingProgress = document.getElementById('dataLoadingProgress');
            
            btn.disabled = true;
            loadingProgress.style.display = 'block';
            document.getElementById('dataProgressMessage').textContent = 'Loading existing data...';
            document.getElementById('dataProgressFill').style.width = '50%';
            
            addLog('Loading existing data...');
            
            try {
                const response = await fetch('/api/load-existing-data', { method: 'POST' });
                const data = await response.json();
                
                document.getElementById('dataProgressFill').style.width = '100%';
                document.getElementById('dataProgressPercent').textContent = '100%';
                
                setTimeout(() => {
                    updateDataStatus(data);
                    addLog(`Loaded ${data.rows} candles`);
                    btn.disabled = false;
                    btn.innerHTML = 'Fetch Data';
                }, 500);
                
            } catch (error) {
                addLog(`Error: ${error.message}`);
                btn.disabled = false;
                loadingProgress.style.display = 'none';
            }
        }

        // ============ UNIFIED OPTIMIZATION ============

        let unifiedPolling = null;
        let sseEventSource = null;
        let streamedResults = [];  // Track streamed results

        async function runUnifiedOptimization() {
            const btn = document.getElementById('unifiedBtn');
            const capital = parseFloat(document.getElementById('unifiedCapital').value) || 1000;
            const riskPercent = parseFloat(document.getElementById('unifiedRisk').value) || 75;
            const nTrials = parseInt(document.getElementById('unifiedTrials').value) || 300;

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Finding profitable strategies...';

            document.getElementById('unifiedProgress').style.display = 'block';
            document.getElementById('unifiedResults').innerHTML = createStreamingResultsContainer();
            document.getElementById('unifiedProgressFill').style.width = '0%';
            document.getElementById('unifiedMessage').textContent = 'Starting multi-engine optimization...';

            // Reset streamed results
            streamedResults = [];

            addLog(`üî¨ Running dual-engine optimization: TradingView + Native (TA-Lib)...`);

            try {
                // Get backtest date range settings
                const dateRange = getBacktestDateRange();

                const response = await fetch('/api/run-unified', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        capital: capital,
                        risk_percent: riskPercent,
                        n_trials: nTrials,
                        engine: 'all',  // Always run all engines for comparison
                        date_range: dateRange
                    })
                });

                const data = await response.json();
                addLog(data.message);

                // Start SSE streaming for real-time results
                startSSEStream();

                // Start polling for unified status (for progress updates)
                startUnifiedPolling();

            } catch (error) {
                addLog(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = 'Find Best Strategies';
            }
        }

        function createStreamingResultsContainer() {
            return `
                <div id="streamingResults" style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--accent-secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="pulse-dot"></span> Live Results (streaming)
                    </h4>
                    <div id="streamingTable" style="max-height: 400px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead style="position: sticky; top: 0; background: var(--bg-card);">
                                <tr style="color: var(--text-muted); text-align: left;">
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">#</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">Eng</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">Strategy</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">TP/SL</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">Trades</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">Win%</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">PF</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">Return</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);" title="Max Drawdown">DD</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">B&H</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);" title="Consistency Score">Cons</th>
                                    <th style="padding: 0.5rem; border-bottom: 1px solid var(--border);">Score</th>
                                </tr>
                            </thead>
                            <tbody id="streamingTableBody"></tbody>
                        </table>
                    </div>
                    <p id="streamingCount" style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.85rem;">
                        Waiting for results...
                    </p>
                </div>
            `;
        }

        function startSSEStream() {
            // Close any existing connection
            if (sseEventSource) {
                sseEventSource.close();
            }

            sseEventSource = new EventSource('/api/unified-stream');

            sseEventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'connected') {
                        addLog('üì° Real-time stream connected');
                    } else if (data.type === 'strategy_result') {
                        handleStreamedResult(data);
                    } else if (data.type === 'tuning_progress') {
                        // Phase 2: Tuning progress update
                        const msg = `üîß Tuning ${data.current}/${data.total}: ${data.strategy} (${data.direction})`;
                        document.getElementById('unifiedProgressMessage').textContent = msg;
                        addLog(msg);
                    } else if (data.type === 'tuning_result') {
                        // Phase 2: Individual tuning result
                        handleTuningResult(data);
                    } else if (data.type === 'complete') {
                        addLog('‚úÖ Streaming complete');
                        sseEventSource.close();
                        sseEventSource = null;
                    }
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            };

            sseEventSource.onerror = (error) => {
                console.error('SSE error:', error);
                // Don't close on error, let it reconnect
            };
        }

        function handleStreamedResult(data) {
            streamedResults.push(data);

            // Sort by COMPOSITE SCORE (balanced ranking)
            streamedResults.sort((a, b) => (b.composite_score || 0) - (a.composite_score || 0));

            // Update the streaming table
            const tbody = document.getElementById('streamingTableBody');
            if (tbody) {
                tbody.innerHTML = streamedResults.slice(0, 20).map((r, idx) => {
                    const wins = r.wins || 0;
                    const losses = r.losses || 0;
                    const total = r.total_trades || (wins + losses);
                    const returnPct = r.total_pnl_percent || 0;
                    const returnGBP = r.total_pnl || 0;
                    const score = r.composite_score || 0;
                    const vsBH = r.vs_buy_hold || 0;
                    const beatsBH = r.beats_buy_hold || false;
                    const maxDD = r.max_drawdown_percent || 0;
                    const consistency = r.consistency_score || 50;
                    const periodMetrics = r.period_metrics || {};

                    // Engine tag colors (TV = TradingView, NT = Native/TA-Lib)
                    const engineColors = { 'TV': '#2962FF', 'NT': '#22c55e' };
                    const engineTag = r.engine_tag || 'TV';
                    const engineColor = engineColors[engineTag] || '#666';

                    // DD color: green < 5%, yellow 5-15%, red > 15%
                    const ddColor = maxDD < 5 ? 'var(--success)' : maxDD < 15 ? 'var(--warning)' : 'var(--danger)';

                    // Consistency color: green >= 70, yellow >= 50, red < 50
                    const consColor = consistency >= 70 ? 'var(--success)' : consistency >= 50 ? 'var(--warning)' : 'var(--danger)';

                    // Build period metrics row
                    const availablePeriods = Object.keys(periodMetrics);
                    let periodRow = '';
                    if (availablePeriods.length > 0) {
                        const validPeriods = availablePeriods.filter(p => periodMetrics[p] && periodMetrics[p].trades > 0);
                        if (validPeriods.length > 0) {
                            // Build sub-table header row
                            const headerCells = validPeriods.map(p =>
                                `<th style="padding: 0.2rem 0.5rem; color: var(--text-muted); font-weight: 600; font-size: 0.7rem; text-align: center; border-bottom: 1px solid var(--border-subtle);">${p.toUpperCase()}</th>`
                            ).join('');

                            // Build data cells for each metric
                            const wrCells = validPeriods.map(p => {
                                const pm = periodMetrics[p];
                                const wrColor = pm.win_rate >= 60 ? 'var(--success)' : pm.win_rate >= 50 ? 'var(--warning)' : 'var(--danger)';
                                return `<td style="padding: 0.15rem 0.5rem; color: ${wrColor}; font-size: 0.75rem; text-align: center;">${pm.win_rate?.toFixed(0) || '-'}%</td>`;
                            }).join('');

                            const pnlCells = validPeriods.map(p => {
                                const pm = periodMetrics[p];
                                const pnlColor = pm.pnl >= 0 ? 'var(--success)' : 'var(--danger)';
                                return `<td style="padding: 0.15rem 0.5rem; color: ${pnlColor}; font-size: 0.75rem; text-align: center;">${pm.pnl >= 0 ? '+' : ''}¬£${pm.pnl?.toFixed(0) || '0'}</td>`;
                            }).join('');

                            const ddCells = validPeriods.map(p => {
                                const pm = periodMetrics[p];
                                const ddPctColor = (pm.max_dd_pct || 0) < 5 ? 'var(--success)' : (pm.max_dd_pct || 0) < 15 ? 'var(--warning)' : 'var(--danger)';
                                return `<td style="padding: 0.15rem 0.5rem; color: ${ddPctColor}; font-size: 0.7rem; text-align: center;">-${(pm.max_dd_pct || 0).toFixed(1)}%</td>`;
                            }).join('');

                            const tradeCells = validPeriods.map(p => {
                                const pm = periodMetrics[p];
                                return `<td style="padding: 0.15rem 0.5rem; color: var(--text-muted); font-size: 0.7rem; text-align: center;">${pm.trades}</td>`;
                            }).join('');

                            periodRow = `
                            <tr class="period-row" style="background: var(--bg-secondary);">
                                <td colspan="12" style="padding: 0.3rem 0.5rem 0.4rem 2rem;">
                                    <table style="border-collapse: collapse; font-size: 0.75rem;">
                                        <tr>
                                            <td style="padding: 0.15rem 0.4rem; color: var(--text-muted); font-size: 0.65rem; text-align: right;">Period</td>
                                            ${headerCells}
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.15rem 0.4rem; color: var(--text-muted); font-size: 0.65rem; text-align: right;">Win%</td>
                                            ${wrCells}
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.15rem 0.4rem; color: var(--text-muted); font-size: 0.65rem; text-align: right;">P&L</td>
                                            ${pnlCells}
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.15rem 0.4rem; color: var(--text-muted); font-size: 0.65rem; text-align: right;">DD</td>
                                            ${ddCells}
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.15rem 0.4rem; color: var(--text-muted); font-size: 0.65rem; text-align: right;">Trades</td>
                                            ${tradeCells}
                                        </tr>
                                    </table>
                                </td>
                            </tr>`;
                        }
                    }

                    return `
                    <tr style="border-bottom: 1px solid var(--border-subtle); ${idx === 0 ? 'background: rgba(34, 197, 94, 0.1);' : ''}">
                        <td style="padding: 0.4rem 0.5rem; color: ${idx < 3 ? 'var(--success)' : 'var(--text-muted)'};">${idx + 1}</td>
                        <td style="padding: 0.4rem 0.5rem;">
                            <span style="background: ${engineColor}; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">${engineTag}</span>
                        </td>
                        <td style="padding: 0.4rem 0.5rem;">
                            <span style="color: var(--text-primary);">${r.strategy_name}</span>
                            <span style="color: var(--text-muted); font-size: 0.75rem; display: block;">${r.strategy_category}</span>
                        </td>
                        <td style="padding: 0.4rem 0.5rem; color: #3b82f6; font-size: 0.8rem;">${(r.params?.tp_percent || 1.0).toFixed(1)}/${(r.params?.sl_percent || 3.0).toFixed(1)}%</td>
                        <td style="padding: 0.4rem 0.5rem;">
                            <span style="color: var(--success);">${wins}</span>/<span style="color: var(--danger);">${losses}</span>
                            <span style="color: var(--text-muted); font-size: 0.7rem;"> (${total})</span>
                        </td>
                        <td style="padding: 0.4rem 0.5rem; color: ${r.win_rate >= 60 ? 'var(--success)' : r.win_rate >= 50 ? 'var(--warning)' : 'var(--danger)'};">${r.win_rate.toFixed(1)}%</td>
                        <td style="padding: 0.4rem 0.5rem; color: var(--accent-secondary);">${(r.profit_factor || 0).toFixed(2)}</td>
                        <td style="padding: 0.4rem 0.5rem;">
                            <span style="color: ${returnPct >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 500;">${returnPct.toFixed(1)}%</span>
                            <span style="color: var(--text-muted); font-size: 0.65rem; display: block;">¬£${returnGBP.toFixed(0)}</span>
                        </td>
                        <td style="padding: 0.4rem 0.5rem; color: ${ddColor};">-${maxDD.toFixed(1)}%</td>
                        <td style="padding: 0.4rem 0.5rem; color: ${(returnPct - vsBH) >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 500;">
                            ${(returnPct - vsBH) >= 0 ? '+' : ''}${(returnPct - vsBH).toFixed(1)}%
                        </td>
                        <td style="padding: 0.4rem 0.5rem; color: ${consColor};">${consistency.toFixed(0)}</td>
                        <td style="padding: 0.4rem 0.5rem; color: var(--accent-primary); font-weight: 600;">${score.toFixed(0)}</td>
                    </tr>
                    ${periodRow}
                `}).join('');
            }

            // Update count
            const countEl = document.getElementById('streamingCount');
            if (countEl) {
                const profitable = streamedResults.filter(r => r.total_pnl > 0).length;
                const beatsBH = streamedResults.filter(r => r.beats_buy_hold).length;
                countEl.textContent = `${profitable} profitable | ${beatsBH} beat Buy & Hold (ranked by composite score)`;
            }
        }

        // Phase 2: Store tuning results - keyed by "strategyName_direction" for quick lookup
        let tuningResults = [];
        let tuningResultsMap = {};

        function handleTuningResult(data) {
            // Store the tuning result
            if (data.tuning) {
                tuningResults.push(data.tuning);

                // Build a key for quick lookup (e.g., "rsi_extreme_long_long" or "rsi_extreme_long")
                const key = `${data.tuning.strategy_name}_${data.tuning.direction}`.toLowerCase();
                tuningResultsMap[key] = data.tuning;

                // Also store by entry_rule if available
                if (data.tuning.entry_rule) {
                    const altKey = `${data.tuning.entry_rule}_${data.tuning.direction}`.toLowerCase();
                    tuningResultsMap[altKey] = data.tuning;
                }

                // Log the tuning result
                const t = data.tuning;
                const improved = t.is_improved ? '‚úÖ' : '‚ûñ';
                const scoreChange = t.improvements?.score || 0;
                addLog(`${improved} ${t.strategy_name} (${t.direction}): Score ${t.before?.score?.toFixed(1)} ‚Üí ${t.after?.score?.toFixed(1)} (${scoreChange >= 0 ? '+' : ''}${scoreChange.toFixed(1)}%)`);

                // Update streaming table to show tuning column
                updateStreamingTableWithTuning();
            }
        }

        function updateStreamingTableWithTuning() {
            // This can be called to refresh the streaming table with tuning info
            // For now we just log - the full display happens in displayUnifiedReport
        }

        // Helper to find tuning result for a strategy
        function findTuningForStrategy(strat) {
            // Try multiple key patterns to find the matching tuning result
            const stratName = (strat.strategy_name || '').toLowerCase();
            const direction = (strat.direction || 'long').toLowerCase();
            const entryRule = (strat.entry_rule || strat.params?.entry_rule || '').toLowerCase();

            // Try direct match first
            let tuning = tuningResultsMap[`${stratName}_${direction}`];
            if (tuning) return tuning;

            // Try entry_rule match
            if (entryRule) {
                tuning = tuningResultsMap[`${entryRule}_${direction}`];
                if (tuning) return tuning;
            }

            // Try finding in array with partial matching
            return tuningResults.find(t => {
                const tName = (t.strategy_name || '').toLowerCase();
                const tDir = (t.direction || '').toLowerCase();
                return (tName === stratName || tName.includes(entryRule)) && tDir === direction;
            });
        }

        // Load tuning results from report payload
        function loadTuningResultsFromReport(report) {
            const tuningData = report.tuning_results || [];
            tuningResults = tuningData;
            tuningResultsMap = {};

            tuningData.forEach(t => {
                const key = `${t.strategy_name}_${t.direction}`.toLowerCase();
                tuningResultsMap[key] = t;

                if (t.entry_rule) {
                    const altKey = `${t.entry_rule}_${t.direction}`.toLowerCase();
                    tuningResultsMap[altKey] = t;
                }
            });

            if (tuningData.length > 0) {
                addLog(`üìä Loaded ${tuningData.length} tuning results from report`);
            }
        }

        // Helper function to render tuning comparison UI for a strategy
        function renderTuningSection(tuning) {
            if (!tuning || !tuning.tuned_params || Object.keys(tuning.tuned_params).length === 0) {
                return '<div style="color: var(--text-muted); font-size: 0.8rem; padding: 0.5rem;">No tunable parameters for this strategy</div>';
            }

            const improved = tuning.is_improved;
            const borderColor = improved ? 'var(--success)' : 'var(--text-muted)';
            const bgColor = improved ? 'rgba(34, 197, 94, 0.05)' : 'rgba(100, 100, 100, 0.05)';

            let paramRows = '';
            for (const [param, value] of Object.entries(tuning.tuned_params)) {
                const defaultVal = tuning.default_params?.[param];
                const changed = defaultVal !== undefined && defaultVal !== value;
                const changeIndicator = changed ?
                    `<span style="color: var(--success);">‚úì Changed</span>` :
                    `<span style="color: var(--text-muted);">-</span>`;

                paramRows += `
                    <tr style="border-bottom: 1px solid var(--border-subtle);">
                        <td style="padding: 0.3rem 0.5rem; color: var(--text-secondary);">${param}</td>
                        <td style="padding: 0.3rem 0.5rem; text-align: center; color: var(--text-muted);">${defaultVal ?? '-'}</td>
                        <td style="padding: 0.3rem 0.5rem; text-align: center; font-weight: 600; color: ${changed ? 'var(--success)' : 'var(--text-primary)'};">${value}</td>
                        <td style="padding: 0.3rem 0.5rem; text-align: center; font-size: 0.75rem;">${changeIndicator}</td>
                    </tr>
                `;
            }

            return `
                <div style="background: ${bgColor}; border-radius: 8px; padding: 0.75rem; border-left: 3px solid ${borderColor}; margin-top: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">
                            üîß Indicator Tuning ${improved ? '<span style="color: var(--success);">- Improved!</span>' : ''}
                        </span>
                    </div>

                    <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-card); border-bottom: 1px solid var(--border);">
                                <th style="padding: 0.3rem 0.5rem; text-align: left; color: var(--text-muted);">Parameter</th>
                                <th style="padding: 0.3rem 0.5rem; text-align: center; color: var(--text-muted);">Before</th>
                                <th style="padding: 0.3rem 0.5rem; text-align: center; color: var(--text-muted);">After</th>
                                <th style="padding: 0.3rem 0.5rem; text-align: center; color: var(--text-muted);">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paramRows}
                        </tbody>
                    </table>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.75rem; font-size: 0.75rem;">
                        <div style="text-align: center; padding: 0.4rem; background: var(--bg-card); border-radius: 4px;">
                            <div style="color: var(--text-muted);">Score</div>
                            <div style="font-weight: 600;">
                                ${tuning.before?.score?.toFixed(1) || 'N/A'} ‚Üí
                                <span style="color: ${tuning.improvements?.score >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${tuning.after?.score?.toFixed(1) || 'N/A'}
                                </span>
                            </div>
                            <div style="color: ${tuning.improvements?.score >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 0.7rem;">
                                ${tuning.improvements?.score >= 0 ? '+' : ''}${tuning.improvements?.score?.toFixed(1) || 0}%
                            </div>
                        </div>
                        <div style="text-align: center; padding: 0.4rem; background: var(--bg-card); border-radius: 4px;">
                            <div style="color: var(--text-muted);">Win Rate</div>
                            <div style="font-weight: 600;">
                                ${tuning.before?.win_rate?.toFixed(1) || 'N/A'}% ‚Üí
                                <span style="color: ${tuning.improvements?.win_rate >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${tuning.after?.win_rate?.toFixed(1) || 'N/A'}%
                                </span>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 0.4rem; background: var(--bg-card); border-radius: 4px;">
                            <div style="color: var(--text-muted);">Profit Factor</div>
                            <div style="font-weight: 600;">
                                ${tuning.before?.profit_factor?.toFixed(2) || 'N/A'} ‚Üí
                                <span style="color: ${tuning.improvements?.profit_factor >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${tuning.after?.profit_factor?.toFixed(2) || 'N/A'}
                                </span>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 0.4rem; background: var(--bg-card); border-radius: 4px;">
                            <div style="color: var(--text-muted);">P&L</div>
                            <div style="font-weight: 600;">
                                ${tuning.before?.pnl_percent?.toFixed(1) || 'N/A'}% ‚Üí
                                <span style="color: ${tuning.improvements?.pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${tuning.after?.pnl_percent?.toFixed(1) || 'N/A'}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function startUnifiedPolling() {
            if (unifiedPolling) clearInterval(unifiedPolling);
            
            unifiedPolling = setInterval(async () => {
                try {
                    const response = await fetch('/api/unified-status');
                    const status = await response.json();
                    
                    document.getElementById('unifiedProgressFill').style.width = `${status.progress}%`;
                    document.getElementById('unifiedMessage').textContent = status.message;
                    
                    if (!status.running) {
                        clearInterval(unifiedPolling);
                        unifiedPolling = null;
                        
                        const btn = document.getElementById('unifiedBtn');
                        btn.disabled = false;
                        btn.innerHTML = 'Find Best Strategies';
                        
                        if (status.report) {
                            displayUnifiedReport(status.report);
                            addLog('Unified optimization complete! Check the Top 10 results below.');
                        }
                    }
                } catch (error) {
                    console.error('Unified polling error:', error);
                }
            }, 1000);
        }
        
        // Store the current report globally for engine switching
        let currentReport = null;
        let selectedEngine = 'tradingview';

        function displayUnifiedReport(report) {
            const container = document.getElementById('unifiedResults');
            currentReport = report;

            // Load tuning results from report
            loadTuningResultsFromReport(report);

            // Show the comparison card once we have results
            showComparisonCard();

            // Check if this is a comparison mode report
            const isComparisonMode = report.mode === 'comparison' && report.engine_reports;

            if (isComparisonMode) {
                displayComparisonReport(report, container);
            } else {
                displaySingleEngineReport(report, container);
            }
        }

        function displayComparisonReport(report, container) {
            const engineReports = report.engine_reports || {};
            const engines = report.engines || ['tradingview', 'native'];
            const bestEngine = report.best_engine || 'tradingview';

            // Combine all strategies from all engines with engine tag
            let allStrategies = [];
            engines.forEach(eng => {
                const engReport = engineReports[eng] || {};
                const top10 = engReport.top_10 || [];
                const engineTag = eng === 'tradingview' ? 'TV' : 'NT';
                top10.forEach((strat, originalRank) => {
                    allStrategies.push({
                        ...strat,
                        engine: eng,
                        engine_tag: engineTag,
                        original_rank: originalRank + 1  // Store original rank (1-indexed)
                    });
                });
            });

            // Sort by composite score
            allStrategies.sort((a, b) => (b.composite_score || 0) - (a.composite_score || 0));

            // Take top 10 overall
            const topStrategies = allStrategies.slice(0, 10);

            // Engine tag colors
            const engineColors = { 'TV': '#2962FF', 'NT': '#22c55e' };

            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-hover); border-radius: 8px;">
                    <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">
                        <strong>Data:</strong> ${report.data_rows?.toLocaleString() || 'N/A'} candles |
                        <strong>Symbol:</strong> ${report.symbol || 'N/A'} |
                        <strong>Timeframe:</strong> ${report.timeframe || 'N/A'} |
                        <span style="color: var(--text-muted);">Engine tags: </span>
                        <span style="background: #2962FF; color: white; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.7rem;">TV</span>=TradingView
                        <span style="background: #22c55e; color: white; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.7rem; margin-left: 0.5rem;">NT</span>=Native (TA-Lib)
                    </p>
                </div>

                <h3 style="color: var(--accent-primary); margin-bottom: 1rem;">üéØ Top 10 Strategies</h3>
            `;

            topStrategies.forEach((strat, idx) => {
                const m = strat.metrics || {};
                const engineTag = strat.engine_tag;
                const engineColor = engineColors[engineTag] || '#666';
                const engine = strat.engine;

                html += `
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; ${idx === 0 ? 'border-color: var(--success); background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), transparent);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: bold; color: ${idx < 3 ? 'var(--success)' : 'var(--text-muted)'};">#${idx + 1}</span>
                                <span style="background: ${engineColor}; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">${engineTag}</span>
                                <span style="color: var(--text-primary); font-weight: 600;">${strat.strategy_name}</span>
                                <span style="color: var(--text-muted); font-size: 0.8rem;">${strat.strategy_category || ''}</span>
                            </div>
                            <span style="text-align: right;">
                                <span style="color: ${(m.total_pnl || 0) >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold; font-size: 1.1rem;">${(strat.total_pnl_percent || m.total_pnl_percent || 0).toFixed(1)}%</span>
                                <span style="color: var(--text-muted); font-size: 0.75rem; display: block;">¬£${(m.total_pnl || 0).toFixed(0)}</span>
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; font-size: 0.85rem; margin-bottom: 0.75rem;">
                            <div>
                                <span style="color: var(--text-muted);">TP/SL:</span><br>
                                <span style="color: #3b82f6;">${(strat.params?.tp_percent || 1.0).toFixed(1)}/${(strat.params?.sl_percent || 3.0).toFixed(1)}%</span>
                            </div>
                            <div>
                                <span style="color: var(--text-muted);">Trades:</span><br>
                                <span style="color: var(--success);">${m.wins || 0}</span>/<span style="color: var(--danger);">${m.losses || 0}</span>
                            </div>
                            <div>
                                <span style="color: var(--text-muted);">Win Rate:</span><br>
                                <span style="color: ${(m.win_rate || 0) >= 60 ? 'var(--success)' : (m.win_rate || 0) >= 50 ? 'var(--warning)' : 'var(--danger)'};">${(m.win_rate || 0).toFixed(1)}%</span>
                            </div>
                            <div>
                                <span style="color: var(--text-muted);">Profit Factor:</span><br>
                                <span style="color: var(--accent-secondary);">${(m.profit_factor || 0).toFixed(2)}</span>
                            </div>
                            <div>
                                <span style="color: var(--text-muted);">Score:</span><br>
                                <span style="color: var(--accent-primary); font-weight: 600;">${(strat.composite_score || 0).toFixed(0)}</span>
                            </div>
                        </div>
                        ${renderTuningSectionForCard(strat)}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem;">
                            <button onclick="exportStrategyPineScriptWithEngine(${strat.original_rank}, '${engine}')" class="btn btn-success" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                üìã Copy Pine
                            </button>
                            <button onclick="downloadStrategyPineScriptWithEngine(${strat.original_rank}, '${engine}')" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                ‚¨áÔ∏è Download
                            </button>
                            <button onclick="openStrategyInTradingViewWithEngine(${strat.original_rank}, '${engine}')" class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #2962FF, #00BCD4);">
                                üìà TradingView
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderStrategyCard(strat, idx, engine) {
            const metrics = strat.metrics || {};
            const params = strat.params || {};
            const isTopPick = idx === 0;
            const isTop3 = idx < 3;
            const borderColor = isTopPick ? 'var(--success)' : (isTop3 ? 'var(--accent-primary)' : 'var(--border)');
            const hasOpenPosition = strat.has_open_position || false;
            const openPosition = strat.open_position || null;

            // Build open position warning HTML
            let openPositionWarning = '';
            if (hasOpenPosition && openPosition) {
                const isLosing = openPosition.unrealized_pnl < 0;
                openPositionWarning = `
                    <div style="margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: ${isLosing ? 'rgba(239, 68, 68, 0.15)' : 'rgba(34, 197, 94, 0.15)'}; border: 1px solid ${isLosing ? 'var(--danger)' : 'var(--success)'}; border-radius: 6px; font-size: 0.75rem;">
                        <span style="font-weight: 600; color: ${isLosing ? 'var(--danger)' : 'var(--success)'};">‚ö†Ô∏è Open ${openPosition.direction.toUpperCase()} Position</span>
                        <span style="color: var(--text-muted); margin-left: 0.5rem;">
                            Entry: $${openPosition.entry_price?.toLocaleString() || '?'} ‚Üí Now: $${openPosition.current_price?.toLocaleString() || '?'}
                        </span>
                        <span style="font-weight: 600; color: ${isLosing ? 'var(--danger)' : 'var(--success)'}; margin-left: 0.5rem;">
                            ${openPosition.unrealized_pnl >= 0 ? '+' : ''}¬£${openPosition.unrealized_pnl?.toFixed(2) || '0'} (${openPosition.unrealized_pnl_pct >= 0 ? '+' : ''}${openPosition.unrealized_pnl_pct?.toFixed(2) || '0'}%)
                        </span>
                    </div>
                `;
            }

            return `
                <div style="background: var(--bg-hover); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid ${borderColor}; ${isTopPick ? 'box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
                        <div>
                            <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                ${isTopPick ? '<span style="font-size: 1.25rem;">üëë</span>' : `<span style="color: var(--text-muted);">#${idx + 1}</span>`}
                                ${strat.strategy_name || 'Unknown Strategy'}
                                ${hasOpenPosition ? '<span style="background: var(--warning); color: #000; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">OPEN TRADE</span>' : ''}
                            </h4>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                ${strat.strategy_category || 'Unknown'} | ${strat.direction || 'both'} | TP: ${params.tp_percent?.toFixed(1) || '?'}% / SL: ${params.sl_percent?.toFixed(1) || '?'}%
                            </div>
                            ${openPositionWarning}
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${metrics.total_pnl >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.25rem; font-weight: 700;">
                                ${metrics.total_pnl >= 0 ? '+' : ''}${(metrics.total_pnl_percent || 0).toFixed(1)}%
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                ¬£${metrics.total_pnl?.toFixed(0) || '0'} | ${metrics.total_trades || 0} trades
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.85rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 8px;">
                        <div><span style="color: var(--text-muted);">P.Factor:</span> <strong>${metrics.profit_factor?.toFixed(2) || 'N/A'}</strong></div>
                        <div><span style="color: var(--text-muted);">Avg Trade:</span> <strong>¬£${metrics.avg_trade?.toFixed(2) || '0'}</strong></div>
                        <div><span style="color: var(--text-muted);">Max DD:</span> <strong style="color: var(--danger);">¬£${metrics.max_drawdown?.toFixed(0) || '0'}</strong></div>
                        <div><span style="color: var(--text-muted);">Score:</span> <strong style="color: var(--accent-primary);">${metrics.composite_score?.toFixed(1) || 'N/A'}</strong></div>
                    </div>
                    ${renderTuningSectionForCard(strat)}
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="exportStrategyPineScriptWithEngine(${idx + 1}, '${engine}')" class="btn btn-success" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                            üìã Copy Pine
                        </button>
                        <button onclick="downloadStrategyPineScriptWithEngine(${idx + 1}, '${engine}')" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                            ‚¨áÔ∏è Download .pine
                        </button>
                        <button onclick="openStrategyInTradingViewWithEngine(${idx + 1}, '${engine}')" class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #2962FF, #00BCD4);">
                            üìà TradingView
                        </button>
                    </div>
                </div>
            `;
        }

        // Helper to render tuning section for a strategy card
        function renderTuningSectionForCard(strat) {
            const tuning = findTuningForStrategy(strat);
            if (!tuning) return '';
            return renderTuningSection(tuning);
        }

        function displaySingleEngineReport(report, container) {
            const top10 = report.top_10 || [];

            if (top10.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: var(--danger-bg); border-radius: 8px; border: 1px solid var(--danger);">
                        <h3 style="color: var(--danger); margin-bottom: 0.5rem;">No Profitable Strategies Found</h3>
                        <p style="color: var(--text-muted);">Try using more historical data or different trading pairs.</p>
                    </div>
                `;
                return;
            }

            const buyHoldReturn = report.buy_hold_return || 0;
            const beatsBHCount = report.beats_buy_hold_count || 0;
            const engine = report.engine || 'tradingview';

            let html = `
                <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(139, 92, 246, 0.05)); border-radius: 12px; border-left: 4px solid var(--success);">
                    <h3 style="color: var(--success); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">üèÜ</span> Strategy Search Complete
                    </h3>
                    <p style="color: var(--text-secondary); margin: 0; font-size: 0.95rem;">
                        <strong>Data:</strong> ${report.data_rows?.toLocaleString() || 'N/A'} candles |
                        <strong>Symbol:</strong> ${report.symbol || 'N/A'} |
                        <strong>Timeframe:</strong> ${report.timeframe || 'N/A'} |
                        <strong>Engine:</strong> ${engine.toUpperCase()}
                    </p>
                </div>

                <h3 style="color: var(--accent-primary); margin-bottom: 1rem;">üéØ Top 10 Strategies</h3>
            `;

            top10.forEach((strat, idx) => {
                html += renderStrategyCard(strat, idx, engine);
            });

            container.innerHTML = html;

            top10.forEach((strat, idx) => {
                const metrics = strat.metrics || {};
                const params = strat.params || {};
                const equityCurve = strat.equity_curve || [];

                const isTopPick = idx === 0;
                const isTop3 = idx < 3;
                const borderColor = isTopPick ? 'var(--success)' : (isTop3 ? 'var(--accent-primary)' : 'var(--border)');

                html += `
                    <div style="background: var(--bg-hover); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid ${borderColor}; ${isTopPick ? 'box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
                            <div>
                                <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    ${isTopPick ? '<span style="font-size: 1.25rem;">üëë</span>' : `<span style="color: var(--text-muted);">#${idx + 1}</span>`}
                                    ${strat.strategy_name || 'Unknown Strategy'}
                                </h4>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                    ${strat.strategy_category || ''}
                                    ${(metrics.win_rate || 0) >= 60 ?
                                        `<span style="padding: 0.15rem 0.5rem; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">‚úì High Win Rate</span>` :
                                        ''
                                    }
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="status-badge" style="font-size: 0.85rem; background: rgba(59, 130, 246, 0.2); color: #3b82f6;">
                                    TP: ${(params.tp_percent || 1.0).toFixed(1)}% / SL: ${(params.sl_percent || 3.0).toFixed(1)}%
                                </span>
                                <span class="status-badge success" style="font-size: 0.9rem;">
                                    PF: ${metrics.profit_factor || 0}
                                </span>
                                <span class="status-badge ${(metrics.total_pnl || 0) >= 0 ? 'success' : 'danger'}" style="font-size: 0.9rem;">
                                    ${(metrics.total_pnl_percent || 0).toFixed(1)}% (¬£${(metrics.total_pnl || 0).toFixed(0)})
                                </span>
                            </div>
                        </div>

                        <!-- Metrics Grid -->
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">Trades (W/L)</div>
                                <div style="font-weight: 600; font-size: 1.1rem;">
                                    ${metrics.total_trades || 0} <span style="font-size: 0.8rem; color: var(--text-muted);">(<span style="color: var(--success);">${metrics.wins || 0}</span>/<span style="color: var(--danger);">${metrics.losses || 0}</span>)</span>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">Win Rate</div>
                                <div style="color: ${(metrics.win_rate || 0) >= 60 ? 'var(--success)' : (metrics.win_rate || 0) >= 50 ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600; font-size: 1.1rem;">${(metrics.win_rate || 0).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">Profit Factor</div>
                                <div style="color: ${(metrics.profit_factor || 0) >= 1.5 ? 'var(--success)' : 'var(--warning)'}; font-weight: 600; font-size: 1.1rem;">${(metrics.profit_factor || 0).toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">Return</div>
                                <div style="color: ${(metrics.total_pnl_percent || 0) >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600; font-size: 1.1rem;">${(metrics.total_pnl_percent || 0).toFixed(1)}%</div>
                                <div style="color: var(--text-muted); font-size: 0.65rem;">¬£${(metrics.total_pnl || 0).toFixed(0)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">B&H</div>
                                <div style="color: ${((metrics.total_pnl_percent || 0) - (metrics.vs_buy_hold || 0)) >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600; font-size: 1.1rem;">${((metrics.total_pnl_percent || 0) - (metrics.vs_buy_hold || 0)) >= 0 ? '+' : ''}${((metrics.total_pnl_percent || 0) - (metrics.vs_buy_hold || 0)).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">Max DD</div>
                                <div style="color: var(--danger); font-weight: 600; font-size: 1.1rem;">${(metrics.max_drawdown_percent || 0).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center; padding: 0.6rem; background: var(--bg-card); border-radius: 6px;">
                                <div style="color: var(--text-muted); font-size: 0.7rem;">Score</div>
                                <div style="color: var(--accent-primary); font-weight: 600; font-size: 1.1rem;">${(metrics.composite_score || 0).toFixed(0)}</div>
                            </div>
                        </div>

                        <!-- Equity Curve -->
                        ${equityCurve.length > 0 ? `
                            <div style="background: var(--bg-primary); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; overflow: hidden;">
                                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">üìà Equity Curve</div>
                                <div style="height: 60px; display: flex; align-items: flex-end; gap: 1px;">
                                    ${equityCurve.slice(-50).map((val, i, arr) => {
                                        const min = Math.min(...arr);
                                        const max = Math.max(...arr);
                                        const range = max - min || 1;
                                        const height = ((val - min) / range) * 100;
                                        const color = val >= 0 ? 'var(--success)' : 'var(--danger)';
                                        return `<div style="flex: 1; height: ${Math.max(height, 2)}%; background: ${color}; border-radius: 1px 1px 0 0;"></div>`;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Parameters -->
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: var(--accent-secondary); font-size: 0.85rem;">‚öôÔ∏è Strategy Parameters</summary>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.75rem; font-size: 0.8rem;">
                                ${Object.entries(params).map(([key, val]) => `
                                    <div style="padding: 0.4rem 0.6rem; background: var(--bg-primary); border-radius: 4px;">
                                        <span style="color: var(--text-muted);">${key}:</span>
                                        <span style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; margin-left: 0.25rem;">${typeof val === 'number' ? val.toFixed(2) : val}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </details>

                        <!-- Action Buttons -->
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="exportStrategyPineScript(${idx + 1})" class="btn btn-success" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                üìã Copy Pine
                            </button>
                            <button onclick="downloadStrategyPineScript(${idx + 1})" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                ‚¨áÔ∏è Download .pine
                            </button>
                            <button onclick="downloadStrategyTradesCSV(${idx + 1})" class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; background: #0ea5e9;">
                                üìä Trades CSV
                            </button>
                            <button onclick="openStrategyInTradingView(${idx + 1})" class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #2962FF, #00BCD4);">
                                üìà TradingView
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        async function uploadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const btn = document.getElementById('uploadCsvBtn');
            const fetchBtn = document.getElementById('fetchDataBtn');
            const loadingProgress = document.getElementById('dataLoadingProgress');
            
            // Show loading UI
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Uploading...';
            fetchBtn.disabled = true;
            
            loadingProgress.style.display = 'block';
            document.getElementById('dataProgressFill').style.width = '30%';
            document.getElementById('dataProgressMessage').textContent = `Uploading ${file.name}...`;
            document.getElementById('dataProgressPercent').textContent = '30%';
            
            addLog(`Uploading TradingView CSV: ${file.name}...`);
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                document.getElementById('dataProgressFill').style.width = '60%';
                document.getElementById('dataProgressPercent').textContent = '60%';
                document.getElementById('dataProgressMessage').textContent = 'Processing CSV...';
                
                const response = await fetch('/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('dataProgressFill').style.width = '100%';
                    document.getElementById('dataProgressPercent').textContent = '100%';
                    document.getElementById('dataProgressMessage').textContent = data.message;
                    
                    addLog(data.message);
                    
                    // Update status after brief delay
                    setTimeout(() => {
                        startPolling();
                    }, 500);
                } else {
                    addLog(`Error: ${data.detail || 'Upload failed'}`);
                    loadingProgress.style.display = 'none';
                }
            } catch (error) {
                addLog(`Error: ${error.message}`);
                loadingProgress.style.display = 'none';
            }
            
            // Reset buttons and file input
            btn.disabled = false;
            btn.innerHTML = 'üìÅ Upload TradingView CSV';
            fetchBtn.disabled = false;
            event.target.value = '';
        }
        
        // Export Pine Script for a specific unified optimizer strategy (copies to clipboard)
        // Get selected Pine Script engine (legacy - for non-comparison mode)
        function getSelectedPineEngine() {
            const select = document.getElementById('pineEngineSelect');
            return select ? select.value : 'tradingview';
        }

        // Engine-specific versions for comparison mode
        async function exportStrategyPineScriptWithEngine(rank, engine) {
            try {
                const engineLabel = engine === 'native' ? 'NATIVE' : 'TRADINGVIEW';
                addLog(`Generating Pine Script for strategy #${rank} [${engineLabel}]...`);
                const response = await fetch(`/api/unified-pinescript/${rank}?engine=${engine}`);

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to generate Pine Script');
                }

                const data = await response.json();

                // Sanitize and copy to clipboard
                const cleanScript = data.pinescript
                    .replace(/\r\n/g, '\n')  // Windows -> Unix
                    .replace(/\r/g, '\n')     // Old Mac -> Unix
                    .replace(/\uFEFF/g, '')   // Remove BOM
                    .replace(/[\u200B-\u200D\uFEFF]/g, '')  // Remove zero-width chars
                    .replace(/\u00A0/g, ' '); // Replace non-breaking space

                await navigator.clipboard.writeText(cleanScript);
                addLog(`‚úÖ Pine Script copied to clipboard [${engineLabel}]`);

            } catch (error) {
                addLog(`‚ùå Error generating Pine Script: ${error.message}`);
            }
        }

        async function downloadStrategyPineScriptWithEngine(rank, engine) {
            try {
                const engineLabel = engine === 'native' ? 'NATIVE' : 'TRADINGVIEW';
                addLog(`Downloading Pine Script for strategy #${rank} [${engineLabel}]...`);
                window.location.href = `/api/download-unified-pinescript/${rank}?engine=${engine}`;
            } catch (error) {
                addLog(`‚ùå Error downloading: ${error.message}`);
            }
        }

        async function openStrategyInTradingViewWithEngine(rank, engine) {
            try {
                const engineLabel = engine === 'native' ? 'NATIVE' : 'TRADINGVIEW';
                addLog(`üìà Fetching TradingView link for strategy #${rank} [${engineLabel}]...`);

                const response = await fetch(`/api/tradingview-link/${rank}?engine=${engine}`);
                if (!response.ok) {
                    throw new Error('Failed to get TradingView link');
                }

                const data = await response.json();

                // Normalize line endings and copy to clipboard
                const cleanScript = data.pinescript.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                await navigator.clipboard.writeText(cleanScript);
                addLog(`üìã Pine Script copied to clipboard [${engineLabel}]`);

                // Show warning if exchange was mapped
                if (data.exchange_warning) {
                    addLog(`‚ö†Ô∏è ${data.exchange_warning}`);
                }

                // Open TradingView in new tab
                window.open(data.tradingview_url, '_blank');
                addLog(`üìà TradingView opened: ${data.exchange}:${data.symbol} (${data.timeframe})`);
                addLog(`üí° Paste Pine Script into Pine Editor (Ctrl+V / Cmd+V)`);

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`);
            }
        }

        async function exportStrategyPineScript(rank) {
            try {
                const engine = getSelectedPineEngine();
                const engineLabel = engine === 'native' ? 'NATIVE' : 'TRADINGVIEW';
                addLog(`Generating Pine Script for strategy #${rank} [${engineLabel}]...`);
                const response = await fetch(`/api/unified-pinescript/${rank}?engine=${engine}`);

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to generate Pine Script');
                }

                const data = await response.json();

                // Normalize line endings and copy to clipboard
                const cleanScript = data.pinescript.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                await navigator.clipboard.writeText(cleanScript);

                addLog(`‚úÖ Pine Script copied for "${data.strategy_name}" (Rank #${rank}) - TP: ${data.tp_percent?.toFixed(1) || '1.0'}% / SL: ${data.sl_percent?.toFixed(1) || '3.0'}% [${engineLabel}]`);

            } catch (error) {
                addLog(`‚ùå Error generating Pine Script: ${error.message}`);
            }
        }

        // Download Pine Script file for a specific strategy
        async function downloadStrategyPineScript(rank) {
            try {
                const engine = getSelectedPineEngine();
                const engineLabel = engine === 'native' ? 'NATIVE' : 'TRADINGVIEW';
                addLog(`Downloading Pine Script for strategy #${rank} [${engineLabel}]...`);
                window.location.href = `/api/download-unified-pinescript/${rank}?engine=${engine}`;
            } catch (error) {
                addLog(`‚ùå Error downloading: ${error.message}`);
            }
        }

        // Download Trades CSV for the currently selected strategy
        async function downloadTradesCSV() {
            const select = document.getElementById('strategyRankSelect');
            const rank = select ? parseInt(select.value) : 1;

            try {
                addLog(`üìä Downloading trades CSV for strategy #${rank}...`);
                window.location.href = `/api/unified-trades-csv/${rank}`;
                addLog(`‚úÖ Trades CSV download started`);
            } catch (error) {
                addLog(`‚ùå Error downloading CSV: ${error.message}`);
            }
        }

        // Download Trades CSV for a specific strategy rank
        async function downloadStrategyTradesCSV(rank) {
            try {
                addLog(`üìä Downloading trades CSV for strategy #${rank}...`);
                window.location.href = `/api/unified-trades-csv/${rank}`;
            } catch (error) {
                addLog(`‚ùå Error downloading CSV: ${error.message}`);
            }
        }

        // Open TradingView with correct symbol/timeframe and copy Pine Script to clipboard
        async function openInTradingView() {
            const select = document.getElementById('strategyRankSelect');
            const rank = select ? parseInt(select.value) : 1;
            await openStrategyInTradingView(rank);
        }

        // Open TradingView for a specific strategy rank
        async function openStrategyInTradingView(rank) {
            try {
                const engine = getSelectedPineEngine();
                const engineLabel = engine === 'native' ? 'NATIVE' : 'TRADINGVIEW';
                addLog(`üìà Fetching TradingView link for strategy #${rank} [${engineLabel}]...`);

                const response = await fetch(`/api/tradingview-link/${rank}?engine=${engine}`);
                if (!response.ok) {
                    throw new Error('Failed to get TradingView link');
                }

                const data = await response.json();

                // Normalize line endings and copy to clipboard
                const cleanScript = data.pinescript.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                await navigator.clipboard.writeText(cleanScript);
                addLog(`üìã Pine Script copied to clipboard [${engineLabel}]`);

                // Show warning if exchange was mapped
                if (data.exchange_warning) {
                    addLog(`‚ö†Ô∏è ${data.exchange_warning}`);
                }

                // Open TradingView in new tab
                window.open(data.tradingview_url, '_blank');
                addLog(`üìà TradingView opened: ${data.exchange}:${data.symbol} (${data.timeframe})`);

                // Show instructions
                let message = `Pine Script copied to clipboard!\n\nIn TradingView:\n1. Open Pine Editor (bottom panel)\n2. Delete existing code\n3. Paste (Ctrl+V / Cmd+V)\n4. Click "Add to chart"\n\nChart: ${data.exchange}:${data.symbol}`;

                if (data.exchange_warning) {
                    message += `\n\n‚ö†Ô∏è ${data.exchange_warning}`;
                }

                alert(message);

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`);
                alert('Error: ' + error.message);
            }
        }
        
        // ============ TRADINGVIEW COMPARISON ============

        async function uploadTVComparison(event) {
            const file = event.target.files[0];
            if (!file) return;

            const rank = parseInt(document.getElementById('comparisonRankSelect').value) || 1;

            addLog(`üìä Uploading TradingView trade export for comparison with strategy #${rank}...`);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`/api/upload-tv-comparison/${rank}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`‚úÖ Comparison complete: ${data.tv_trade_count} TV trades vs ${data.our_trade_count} our trades`);
                    displayComparisonResults(data.comparison);
                } else {
                    addLog(`‚ùå Error: ${data.detail || 'Upload failed'}`);
                }
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`);
            }

            event.target.value = '';
        }

        function displayComparisonResults(comparison) {
            const container = document.getElementById('comparisonResults');
            const summary = comparison.summary;
            const tv = summary.tradingview;
            const ours = summary.our_system;
            const diff = summary.difference;

            let html = `
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <!-- TradingView Results -->
                    <div style="background: linear-gradient(135deg, rgba(41, 98, 255, 0.1), rgba(41, 98, 255, 0.05)); border: 1px solid rgba(41, 98, 255, 0.3); border-radius: 12px; padding: 1rem;">
                        <h4 style="color: #2962FF; margin: 0 0 0.75rem 0; font-size: 1rem;">üì∫ TradingView</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Trades:</span>
                                <span style="font-weight: 600;">${tv.trade_count}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Total P&L:</span>
                                <span style="font-weight: 600; color: ${tv.total_pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${tv.total_pnl.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Win Rate:</span>
                                <span style="font-weight: 600; color: ${tv.win_rate >= 50 ? 'var(--success)' : 'var(--danger)'};">${tv.win_rate.toFixed(1)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">W/L:</span>
                                <span><span style="color: var(--success);">${tv.wins}</span>/<span style="color: var(--danger);">${tv.losses}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Our System Results -->
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 1rem;">
                        <h4 style="color: var(--accent-primary); margin: 0 0 0.75rem 0; font-size: 1rem;">üéØ Our System</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Trades:</span>
                                <span style="font-weight: 600;">${ours.trade_count}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Total P&L:</span>
                                <span style="font-weight: 600; color: ${ours.total_pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${ours.total_pnl.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Win Rate:</span>
                                <span style="font-weight: 600; color: ${ours.win_rate >= 50 ? 'var(--success)' : 'var(--danger)'};">${ours.win_rate.toFixed(1)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">W/L:</span>
                                <span><span style="color: var(--success);">${ours.wins}</span>/<span style="color: var(--danger);">${ours.losses}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Difference -->
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 1rem;">
                        <h4 style="color: var(--warning); margin: 0 0 0.75rem 0; font-size: 1rem;">üìà Difference</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Trade Count:</span>
                                <span style="font-weight: 600; color: ${diff.trade_count_diff === 0 ? 'var(--success)' : 'var(--warning)'};">${diff.trade_count_diff > 0 ? '+' : ''}${diff.trade_count_diff}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">P&L Diff:</span>
                                <span style="font-weight: 600; color: ${diff.pnl_diff >= 0 ? 'var(--success)' : 'var(--danger)'};">${diff.pnl_diff >= 0 ? '+' : ''}¬£${diff.pnl_diff.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Win Rate Diff:</span>
                                <span style="font-weight: 600; color: ${diff.win_rate_diff >= 0 ? 'var(--success)' : 'var(--danger)'};">${diff.win_rate_diff >= 0 ? '+' : ''}${diff.win_rate_diff.toFixed(1)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Match Rate:</span>
                                <span style="font-weight: 600; color: ${comparison.match_rate >= 80 ? 'var(--success)' : comparison.match_rate >= 50 ? 'var(--warning)' : 'var(--danger)'};">${comparison.match_rate.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Match Status -->
                <div style="padding: 1rem; margin-bottom: 1rem; border-radius: 8px; ${comparison.match_rate >= 80 ? 'background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);' : comparison.match_rate >= 50 ? 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);' : 'background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);'}">
                    ${comparison.match_rate >= 80 ?
                        `<span style="color: var(--success); font-weight: 600;">‚úÖ Good Match!</span> ${comparison.match_rate.toFixed(1)}% of TradingView trades matched within 1 hour tolerance.` :
                        comparison.match_rate >= 50 ?
                        `<span style="color: var(--warning); font-weight: 600;">‚ö†Ô∏è Partial Match</span> Only ${comparison.match_rate.toFixed(1)}% matched. Check entry logic or data source differences.` :
                        `<span style="color: var(--danger); font-weight: 600;">‚ùå Low Match Rate</span> Only ${comparison.match_rate.toFixed(1)}% matched. Likely different entry conditions or data source.`
                    }
                </div>
            `;

            // Matched Trades Table
            if (comparison.matched_trades && comparison.matched_trades.length > 0) {
                html += `
                    <details open style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">
                            ‚úÖ Matched Trades (${comparison.matched_trades.length})
                        </summary>
                        <div style="max-height: 300px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead style="position: sticky; top: 0; background: var(--bg-card);">
                                    <tr style="color: var(--text-muted);">
                                        <th style="padding: 0.5rem; text-align: left;">Time</th>
                                        <th style="padding: 0.5rem; text-align: right;">TV P&L</th>
                                        <th style="padding: 0.5rem; text-align: right;">Our P&L</th>
                                        <th style="padding: 0.5rem; text-align: right;">Diff</th>
                                        <th style="padding: 0.5rem; text-align: center;">Quality</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${comparison.matched_trades.map(m => `
                                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                                            <td style="padding: 0.4rem 0.5rem; font-size: 0.75rem;">${m.tv_trade.entry_time}</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: ${m.tv_trade.pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${m.tv_trade.pnl.toFixed(2)}</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: ${m.our_trade.pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${m.our_trade.pnl.toFixed(2)}</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: ${Math.abs(m.pnl_diff) < 1 ? 'var(--success)' : 'var(--warning)'};">¬£${m.pnl_diff.toFixed(2)}</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: center;">
                                                ${m.match_quality === 'exact' ?
                                                    '<span style="color: var(--success);">‚óè</span>' :
                                                    '<span style="color: var(--warning);">‚óê</span>'
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                `;
            }

            // Unmatched TV Trades
            if (comparison.unmatched_tv && comparison.unmatched_tv.length > 0) {
                html += `
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: #2962FF; font-weight: 600; margin-bottom: 0.5rem;">
                            üì∫ TradingView Only (${comparison.unmatched_tv.length} trades we missed)
                        </summary>
                        <div style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem;">
                            ${comparison.unmatched_tv.map(t => `
                                <div style="padding: 0.4rem; border-bottom: 1px solid var(--border-subtle); font-size: 0.8rem;">
                                    <span style="color: var(--text-muted);">${t.entry_time}</span>
                                    <span style="margin-left: 0.5rem; color: ${t.pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${t.pnl.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
            }

            // Unmatched Our Trades
            if (comparison.unmatched_ours && comparison.unmatched_ours.length > 0) {
                html += `
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: 600; margin-bottom: 0.5rem;">
                            üéØ Our System Only (${comparison.unmatched_ours.length} extra trades)
                        </summary>
                        <div style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem;">
                            ${comparison.unmatched_ours.map(t => `
                                <div style="padding: 0.4rem; border-bottom: 1px solid var(--border-subtle); font-size: 0.8rem;">
                                    <span style="color: var(--text-muted);">${t.entry_time}</span>
                                    <span style="margin-left: 0.5rem; color: ${t.pnl >= 0 ? 'var(--success)' : 'var(--danger)'};">¬£${t.pnl.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
            }

            container.innerHTML = html;
        }

        async function clearComparison() {
            try {
                await fetch('/api/comparison', { method: 'DELETE' });
                document.getElementById('comparisonResults').innerHTML = '';
                addLog('Comparison data cleared');
            } catch (error) {
                addLog(`Error clearing comparison: ${error.message}`);
            }
        }

        // Show comparison card when optimization completes
        function showComparisonCard() {
            const card = document.getElementById('comparisonCard');
            if (card) card.style.display = 'block';
        }

        // Polling
        let fastPollingInterval = null;

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);

            // Immediate first poll
            pollStatus();

            pollingInterval = setInterval(pollStatus, 1500);
        }

        function startFastPolling() {
            // Fast polling during data fetch (500ms instead of 1500ms)
            if (fastPollingInterval) clearInterval(fastPollingInterval);
            if (pollingInterval) clearInterval(pollingInterval);

            // Immediate first poll
            pollStatus();

            fastPollingInterval = setInterval(pollStatus, 500);
        }

        function stopFastPolling() {
            if (fastPollingInterval) {
                clearInterval(fastPollingInterval);
                fastPollingInterval = null;
            }
            // Resume normal polling
            startPolling();
        }

        async function pollStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                updateDataStatus(data.data);

                // Handle data loading completion
                if (data.data.loaded) {
                    // Stop fast polling if active, resume normal polling
                    if (fastPollingInterval) {
                        stopFastPolling();
                    }

                    // Stop data loading animation
                    stopDataLoadingAnimation();

                    // Complete progress bar
                    const fill = document.getElementById('dataProgressFill');
                    const pct = document.getElementById('dataProgressPercent');
                    const msg = document.getElementById('dataProgressMessage');
                    if (fill) fill.style.width = '100%';
                    if (pct) pct.textContent = '100%';
                    if (msg) msg.textContent = `‚úì ${data.data.rows?.toLocaleString() || ''} candles loaded`;

                    // Re-enable buttons
                    const fetchBtn = document.getElementById('fetchDataBtn');
                    const uploadBtn = document.getElementById('uploadCsvBtn');
                    if (fetchBtn) {
                        fetchBtn.disabled = false;
                        fetchBtn.innerHTML = 'Fetch Data';
                    }
                    if (uploadBtn) uploadBtn.disabled = false;

                    // Hide progress after a delay
                    setTimeout(() => {
                        const loadingProgress = document.getElementById('dataLoadingProgress');
                        if (loadingProgress && data.data.loaded) {
                            loadingProgress.style.display = 'none';
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('Polling error:', error);
            }
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', async () => {
            addLog('System initialized');
            startPolling();

            // Also do an immediate fetch to populate date range on first load
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                if (data.data && data.data.loaded && data.data.start_date && data.data.end_date) {
                    console.log('Initial date range population:', data.data.start_date, data.data.end_date);
                    updateBacktestDateRange(data.data.start_date, data.data.end_date);
                }
            } catch (e) {
                console.error('Initial status fetch failed:', e);
            }
        });
    </script>

    <!-- Pine Script Modal -->
    <div id="pineScriptModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid var(--border);">
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="pineModalTitle" style="margin: 0; color: var(--text-primary);">Pine Script</h3>
                <button onclick="closePineModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 1rem 1.5rem; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <p style="color: var(--text-muted); margin: 0 0 0.75rem 0; font-size: 0.85rem;">Select all (Ctrl+A / Cmd+A) and copy (Ctrl+C / Cmd+C):</p>
                <textarea id="pineScriptContent" readonly style="flex: 1; width: 100%; min-height: 400px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 0.8rem; resize: none;"></textarea>
            </div>
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="selectAllPineScript()" class="btn btn-secondary" style="font-size: 0.85rem;">Select All</button>
                <button onclick="closePineModal()" class="btn" style="font-size: 0.85rem;">Close</button>
            </div>
        </div>
    </div>

    <script>
        function showPineModal(title, script) {
            document.getElementById('pineModalTitle').textContent = title;
            // Normalize line endings and remove any invisible characters
            const cleanScript = script
                .replace(/\r\n/g, '\n')  // Windows -> Unix
                .replace(/\r/g, '\n')     // Old Mac -> Unix
                .replace(/\uFEFF/g, '')   // Remove BOM
                .replace(/[\u200B-\u200D\uFEFF]/g, '')  // Remove zero-width chars
                .replace(/\u00A0/g, ' '); // Replace non-breaking space with regular space
            document.getElementById('pineScriptContent').value = cleanScript;
            document.getElementById('pineScriptModal').style.display = 'flex';
            // Auto-select the content
            setTimeout(() => {
                const textarea = document.getElementById('pineScriptContent');
                textarea.focus();
                textarea.select();
            }, 100);
        }

        function closePineModal() {
            document.getElementById('pineScriptModal').style.display = 'none';
        }

        function selectAllPineScript() {
            const textarea = document.getElementById('pineScriptContent');
            textarea.focus();
            textarea.select();
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePineModal();
        });

        // Close modal when clicking outside
        document.getElementById('pineScriptModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'pineScriptModal') closePineModal();
        });
    </script>
</body>
</html>

