<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTCGBP ML Optimizer</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <div class="header-title">
                    <h1>Trading Strategy Optimizer</h1>
                    <p>Find profitable strategies automatically. Get TradingView-ready code.</p>
                </div>
                <div id="wsConnectionStatus" class="ws-status ws-connecting">üîÑ Connecting...</div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="main" onclick="showTab('main')">
                    Manual Optimizer
                </button>
                <button class="tab-btn" data-tab="autonomous" onclick="showTab('autonomous')">
                    Auto Optimizer
                </button>
                <button class="tab-btn" data-tab="validation" onclick="showTab('validation')">
                    Manual Validation
                </button>
                <button class="tab-btn" data-tab="history" onclick="showTab('history')">
                    Strategy History
                </button>
                <button class="tab-btn" data-tab="elite" onclick="showTab('elite')">
                    Elite Strategies
                </button>
                <button class="tab-btn" data-tab="tools" onclick="showTab('tools')">
                    Tools
                </button>
            </div>
        </header>

        <!-- Main Tab Content -->
        <div id="main-tab" class="tab-content">
        <div class="grid">
            <!-- Data Section -->
            <div class="card">
                <div class="card-header">
                    <div class="icon">üìä</div>
                    <h2>Data</h2>
                </div>
                
                <div id="dataStatus">
                    <span class="status-badge neutral">No data loaded</span>
                </div>
                
                <div class="input-group" style="margin-top: 1rem;">
                    <label>Data Source</label>
                    <select id="sourceSelect" disabled style="opacity: 0.8;">
                        <option value="binance" selected>Binance (USDT) - TradingView Compatible</option>
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                        Use BINANCE:SYMBOL on TradingView for matching charts
                    </small>
                </div>
                
                <div class="input-group">
                    <label>Trading Pair</label>
                    <select id="pairSelect">
                        <!-- Options populated by JavaScript based on source -->
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Historical Period</label>
                    <select id="monthsSelect">
                        <!-- Options will be populated by JavaScript based on source/interval -->
                        <option value="1" selected>1 month</option>
                        <option value="2">2 months (max)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Timeframe</label>
                    <select id="intervalSelect" onchange="updatePeriodOptions()">
                        <option value="15" selected>15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                    </select>
                </div>
                
                
                <div class="actions">
                    <button class="btn btn-primary" id="fetchDataBtn" onclick="fetchData()">
                        Fetch Data
                    </button>
                    <button class="btn btn-secondary" onclick="loadExistingData()">
                        Load Existing
                    </button>
                </div>
                
                <!-- Data Loading Progress -->
                <div id="dataLoadingProgress" style="display: none; margin-top: 1rem;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="dataProgressFill" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span id="dataProgressMessage" style="color: var(--text-secondary); font-size: 0.9rem;">Loading...</span>
                        <span id="dataProgressPercent" style="color: var(--accent-primary); font-weight: 500;"></span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <label style="color: var(--accent-secondary); font-weight: 500;">üìä TradingView Premium Export (Recommended)</label>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0.5rem 0;">Export chart data from TradingView (Right-click ‚Üí Export chart data)</p>
                    <input type="file" id="csvUpload" accept=".csv" onchange="uploadCSV(event)" style="display: none;">
                    <button class="btn btn-success" id="uploadCsvBtn" onclick="document.getElementById('csvUpload').click()" style="margin-top: 0.5rem;">
                        üìÅ Upload TradingView CSV
                    </button>
                </div>
            </div>

            <!-- Backtest Date Range Section -->
            <div class="card" id="backtestDateCard">
                <div class="card-header">
                    <div class="icon">üìÖ</div>
                    <h2>Backtest Date Range</h2>
                </div>

                <div class="input-group" style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="enableDateRange" checked style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                        <span>Backtest Entries to Date Range</span>
                    </label>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">When enabled, Pine Script will only execute trades within this date range</p>
                </div>

                <div id="dateRangeInputs">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>Start</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="date" id="backtestStartDate" style="flex: 2;">
                                <input type="time" id="backtestStartTime" value="00:00" style="flex: 1;">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>End</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="date" id="backtestEndDate" style="flex: 2;">
                                <input type="time" id="backtestEndTime" value="23:59" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 1rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);">
                    <strong>Tip:</strong> Dates auto-populate from loaded data. Adjust to test specific periods (e.g., exclude first months for indicator warmup, or test specific market conditions).
                </div>

                <!-- Data Statistics -->
                <div id="dataStatsSection" style="display: none; margin-top: 1rem;">
                    <!-- Row 1: Min, Avg, Max Price -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Min Price</div>
                            <div id="statMinPrice" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-danger);">-</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Avg Price</div>
                            <div id="statAvgPrice" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-primary);">-</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Max Price</div>
                            <div id="statMaxPrice" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-success);">-</div>
                        </div>
                    </div>
                    <!-- Row 2: Down Swing, Volatility, Up Swing -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 0.75rem;">
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Largest Down Swing</div>
                            <div id="statMaxDown" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-danger);">-</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Volatility (ATR%)</div>
                            <div id="statVolatility" style="font-size: 1.1rem; font-weight: 600; color: #fbbf24;">-</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Largest Up Swing</div>
                            <div id="statMaxUp" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-success);">-</div>
                        </div>
                    </div>
                    <!-- Row 3: Daily Bull/Bear Timeline -->
                    <div style="margin-top: 0.75rem; background: rgba(30, 30, 40, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.75rem;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Daily Trend Timeline</div>
                        <div id="dailyTrendTimeline" style="display: flex; gap: 2px; flex-wrap: wrap; min-height: 24px;">
                            <!-- Filled by JS -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted);">
                            <span id="timelineStartDate">-</span>
                            <span style="display: flex; gap: 1rem;">
                                <span>üü¢ Bull</span>
                                <span>üî¥ Bear</span>
                                <span>‚ö™ Flat</span>
                            </span>
                            <span id="timelineEndDate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UNIFIED OPTIMIZATION - THE Main Feature -->
            <div class="card full-width" id="unifiedCard" style="position: relative; border: 2px solid var(--accent-primary);">
                <div id="unifiedOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,15,0.85); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: 12px;">
                    <div style="text-align: center; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîí</div>
                        <div>Load data first to start</div>
                    </div>
                </div>

                <div class="card-header">
                    <div class="icon" style="background: linear-gradient(135deg, var(--accent-primary), #ec4899);">üéØ</div>
                    <h2>Find Profitable Strategies <span id="strategyDateRange" style="font-size: 0.85rem; font-weight: normal; color: var(--text-muted);"></span></h2>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(139, 92, 246, 0.4);">
                    <strong>How it works:</strong> Tests <strong>39 entry strategies</strong> (RSI, Bollinger Bands, MACD, Ichimoku, Keltner, Donchian, Aroon, etc.) with both long and short directions. Optimizes <strong>TP/SL percentages</strong> (0.1% - 10%). Native engine also supports candlestick pattern recognition.
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0;">
                    <div class="input-group">
                        <label>Starting Capital (¬£)</label>
                        <input type="number" id="unifiedCapital" value="1000" min="100" max="100000" step="100">
                    </div>
                    <div class="input-group">
                        <label>Position Size (% of equity)</label>
                        <input type="number" id="unifiedRisk" value="75" min="1" max="100" step="5">
                    </div>
                    <div class="input-group">
                        <label>TP/SL Granularity</label>
                        <select id="unifiedTrials">
                            <option value="100">1.0% steps (fast)</option>
                            <option value="225">0.67% steps (balanced)</option>
                            <option value="400" selected>0.5% steps (thorough)</option>
                            <option value="625">0.4% steps (fine)</option>
                            <option value="10000">0.1% steps (exhaustive)</option>
                        </select>
                    </div>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); margin-top: 0.5rem;">
                    <strong>üî¨ Dual-Engine:</strong> TradingView engine for Pine Script export, Native engine (TA-Lib) for fast in-app execution with candlestick patterns.
                </div>

                <!-- VectorBT Status Indicator -->
                <div id="vectorbtStatus" style="margin-top: 0.75rem; display: none;">
                    <div id="vectorbtBadge" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem;">
                        <span id="vectorbtIcon"></span>
                        <span id="vectorbtText"></span>
                        <span id="vectorbtSpeedup" style="font-weight: 600;"></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="unifiedBtn" onclick="runUnifiedOptimization()" style="background: linear-gradient(135deg, var(--accent-primary), #ec4899); font-size: 1.1rem; padding: 1rem 2rem; width: 100%;">
                        Find Best Strategies
                    </button>
                </div>
                
                <div id="unifiedProgress" style="display: none; margin-top: 1.5rem;">
                    <div class="progress-bar" style="height: 12px;">
                        <div class="progress-fill" id="unifiedProgressFill" style="width: 0%; background: linear-gradient(90deg, var(--accent-primary), #ec4899);"></div>
                    </div>
                    <p id="unifiedMessage" style="color: var(--text-secondary); margin-top: 0.75rem; font-size: 0.95rem;"></p>
                </div>
                
                <div id="unifiedResults" style="margin-top: 1.5rem;"></div>
            </div>
            
            <!-- TradingView Comparison Section -->
            <div class="card full-width" id="comparisonCard" style="display: none;">
                <div class="card-header">
                    <div class="icon" style="background: linear-gradient(135deg, #2962FF, #00BCD4);">üìä</div>
                    <h2>TradingView vs Our System Comparison</h2>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(41, 98, 255, 0.1), rgba(0, 188, 212, 0.1)); border: 1px solid rgba(41, 98, 255, 0.3);">
                    <strong>How to compare:</strong>
                    1. Run our optimization on your data.
                    2. Copy the Pine Script to TradingView.
                    3. In TradingView Strategy Tester, click "List of Trades" ‚Üí Export (CSV icon).
                    4. Upload that CSV here to compare.
                </div>

                <div style="display: flex; gap: 1rem; align-items: center; margin: 1rem 0; flex-wrap: wrap;">
                    <div class="input-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                        <label>Compare against strategy:</label>
                        <select id="comparisonRankSelect">
                            <option value="1">#1 Strategy</option>
                            <option value="2">#2 Strategy</option>
                            <option value="3">#3 Strategy</option>
                            <option value="4">#4 Strategy</option>
                            <option value="5">#5 Strategy</option>
                        </select>
                    </div>
                    <div>
                        <input type="file" id="tvComparisonUpload" accept=".csv" onchange="uploadTVComparison(event)" style="display: none;">
                        <button class="btn" onclick="document.getElementById('tvComparisonUpload').click()" style="background: linear-gradient(135deg, #2962FF, #00BCD4); margin-top: 1.25rem;">
                            üìÅ Upload TradingView Trade Export
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="clearComparison()" style="margin-top: 1.25rem;">
                        Clear
                    </button>
                </div>

                <div id="comparisonResults"></div>
            </div>

            <!-- Activity Log -->
            <div class="card full-width">
                <div class="card-header">
                    <div class="icon">üìú</div>
                    <h2>Activity Log</h2>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-time">[00:00:00]</span>
                        System ready. Fetch data to begin.
                    </div>
                </div>
            </div>
        </div>
        </div><!-- End main-tab -->

        <!-- History Tab Content -->
        <div id="history-tab" class="tab-content" style="display: none;">
            <div class="card full-width">
                <div class="card-header">
                    <div class="icon">üìö</div>
                    <h2>Strategy History</h2>
                    <span class="status-badge neutral" id="history-count">Loading...</span>
                </div>

                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="input-group">
                        <label>Trading Pair</label>
                        <select id="filter-symbol" onchange="applyHistoryFilters()">
                            <option value="">All Pairs</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Timeframe</label>
                        <select id="filter-timeframe" onchange="applyHistoryFilters()">
                            <option value="">All Timeframes</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Historical Period</label>
                        <select id="filter-period" onchange="applyHistoryFilters()">
                            <option value="">All Periods</option>
                            <option value="1w">1 Week</option>
                            <option value="2w">2 Weeks</option>
                            <option value="1m">1 Month</option>
                            <option value="3m">3 Months</option>
                            <option value="6m">6 Months</option>
                            <option value="9m">9 Months</option>
                            <option value="1y">1 Year</option>
                            <option value="2y">2 Years</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="resetHistoryFilters()" style="margin-top: 1.5rem;">
                        Reset Filters
                    </button>
                </div>

                <!-- Results Table -->
                <div class="table-container">
                    <table class="history-table" id="history-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="rank" onclick="sortHistoryTable('rank')">#</th>
                                <th class="sortable" data-sort="strategy_name" onclick="sortHistoryTable('strategy_name')">Strategy</th>
                                <th class="sortable" data-sort="symbol" onclick="sortHistoryTable('symbol')">Symbol</th>
                                <th class="sortable" data-sort="period" onclick="sortHistoryTable('period')">Period</th>
                                <th class="sortable" data-sort="timeframe" onclick="sortHistoryTable('timeframe')">TF</th>
                                <th class="sortable" data-sort="tp_percent" onclick="sortHistoryTable('tp_percent')">TP%</th>
                                <th class="sortable" data-sort="sl_percent" onclick="sortHistoryTable('sl_percent')">SL%</th>
                                <th class="sortable active desc" data-sort="composite_score" onclick="sortHistoryTable('composite_score')">Score</th>
                                <th class="sortable" data-sort="win_rate" onclick="sortHistoryTable('win_rate')">Win Rate</th>
                                <th class="sortable" data-sort="profit_factor" onclick="sortHistoryTable('profit_factor')">PF</th>
                                <th class="sortable" data-sort="total_pnl" onclick="sortHistoryTable('total_pnl')">PnL</th>
                                <th class="sortable" data-sort="max_drawdown" onclick="sortHistoryTable('max_drawdown')">DD%</th>
                                <th class="sortable" data-sort="total_trades" onclick="sortHistoryTable('total_trades')">Trades</th>
                                <th class="sortable" data-sort="created_at" onclick="sortHistoryTable('created_at')">Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading/Empty States -->
                <div id="history-loading" class="loading-state">
                    Loading strategies...
                </div>
                <div id="history-empty" class="empty-state" style="display: none;">
                    No strategies found matching your filters.
                </div>
            </div>

            <!-- Strategy Detail Panel -->
            <div id="strategy-detail-panel" class="card full-width" style="display: none; margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="icon">üìä</div>
                    <h2 id="detail-strategy-name">Strategy Details</h2>
                    <button class="btn btn-secondary" onclick="closeStrategyDetail()" style="margin-left: auto;">
                        Close
                    </button>
                </div>
                <div id="strategy-detail-content">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div><!-- End history-tab -->

        <!-- Validation Tab Content -->
        <div id="validation-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon">üî¨</div>
                    <h2>Strategy Validation</h2>
                </div>
                <p style="color: #888; margin-bottom: 1.5rem;">
                    Test a winning strategy across different time periods to validate its robustness.
                    Uses the same parameters (TP%, SL%, entry rule) against fresh data from the same source.
                    <br><span style="color: #666; font-size: 0.85rem;">üí° Tip: Click the üî¨ button in Strategy History for quick validation.</span>
                </p>

                <!-- Strategy Selector -->
                <div class="input-group">
                    <label>Select Strategy to Validate</label>
                    <select id="validationStrategySelect" style="width: 100%; padding: 0.75rem;" onchange="onValidationStrategyChange()">
                        <option value="">-- Select a strategy --</option>
                    </select>
                </div>

                <!-- Capital & Position Size Override -->
                <div class="input-row" style="margin-top: 1rem;">
                    <div class="input-group" style="flex: 1;">
                        <label>Starting Capital (¬£)</label>
                        <input type="number" id="validationCapital" min="100" max="1000000" step="100" value="1000" placeholder="1000">
                        <small style="color: #666; font-size: 0.75rem;">Original: <span id="validationOriginalCapital">--</span></small>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label>Position Size (%)</label>
                        <input type="number" id="validationPositionSize" min="1" max="100" step="1" value="75" placeholder="75">
                        <small style="color: #666; font-size: 0.75rem;">Original: <span id="validationOriginalPosition">--</span></small>
                    </div>
                </div>

                <!-- Validate Button -->
                <button id="validateBtn" onclick="runValidation()" class="btn" style="margin-top: 1rem; width: 100%;">
                    Run Validation (All Periods)
                </button>

                <!-- Progress Indicator -->
                <div id="validationProgress" style="display: none; margin-top: 1rem;">
                    <div class="progress-bar" style="height: 4px; background: #333; border-radius: 2px;">
                        <div id="validationProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00d4ff, #7b68ee); border-radius: 2px; transition: width 0.3s;"></div>
                    </div>
                    <p id="validationProgressText" style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">Validating...</p>
                </div>
            </div>

            <!-- Validation Results -->
            <div id="validationResults" class="card" style="display: none; margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="icon">üìä</div>
                    <h2 id="validationResultsTitle">Validation Results</h2>
                </div>

                <!-- Strategy Info -->
                <div id="validationStrategyInfo" style="margin-bottom: 1rem; padding: 1rem; background: #1a1a2e; border-radius: 8px;">
                    <!-- Populated dynamically -->
                </div>

                <!-- Results Table -->
                <div style="overflow-x: auto;">
                    <table class="history-table" id="validationTable">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>PnL</th>
                                <th>Drawdown</th>
                                <th>Profit Factor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="validationTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div><!-- End validation-tab -->

        <!-- Elite Strategies Tab Content -->
        <div id="elite-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon">üèÜ</div>
                    <h2>Elite Strategies</h2>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                    Strategies validated across ALL time periods. Elite status means consistent performance.
                </p>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">
                    üìä Validation settings: ¬£1,000 capital, 100% position size, 0.1% commission. Returns shown as % of starting capital.
                </p>

                <!-- Status Bar -->
                <div class="elite-status-bar">
                    <span class="elite-badge validated-status">Validated: <span id="validatedCount">0</span></span>
                    <span class="elite-badge pending-status">Queue: <span id="pendingCount">0</span></span>
                    <span class="elite-badge untestable-status">Untestable: <span id="untestableCount">0</span></span>
                    <span id="eliteProgress" class="elite-progress"></span>
                    <span id="eliteProgressCount" style="margin-left: auto; color: var(--text-muted); font-size: 0.85rem;"></span>
                </div>

                <!-- Validation Queue (shown during validation) -->
                <div class="task-queue" id="eliteValidationQueue" style="display: none; margin-top: 1rem;">
                    <div class="task-queue-header">
                        <span>VALIDATION QUEUE</span>
                        <span id="eliteQueueParallelCount" style="margin-left: auto; font-size: 0.75rem; color: var(--text-muted);"></span>
                    </div>
                    <div id="eliteQueueBody">
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                            No pending validations
                        </div>
                    </div>
                </div>

                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                    Validation runs automatically in the background. Pauses when optimizer is active.
                </p>

                <!-- Elite Filter Controls -->
                <div class="filter-controls" style="margin-top: 1rem;">
                    <div class="input-group">
                        <label>Search Strategy</label>
                        <input type="text" id="elite-filter-search" placeholder="Search name..." oninput="applyEliteFilters()">
                    </div>

                    <div class="input-group">
                        <label>Trading Pair</label>
                        <select id="elite-filter-symbol" onchange="applyEliteFilters()">
                            <option value="">All Pairs</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Direction</label>
                        <select id="elite-filter-direction" onchange="applyEliteFilters()">
                            <option value="">All</option>
                            <option value="long">Long Only</option>
                            <option value="short">Short Only</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="resetEliteFilters()" style="margin-top: 1.5rem;">
                        Reset Filters
                    </button>
                </div>

                <!-- Elite Strategies Table -->
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table class="history-table elite-table" id="eliteTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="rank" onclick="sortEliteTable('rank')">#</th>
                                <th class="sortable active desc" data-sort="score" onclick="sortEliteTable('score')">Score</th>
                                <th class="sortable" data-sort="strategy" onclick="sortEliteTable('strategy')" style="text-align: left;">Strategy</th>
                                <th class="sortable" data-sort="1w" onclick="sortEliteTable('1w')">1W</th>
                                <th class="sortable" data-sort="2w" onclick="sortEliteTable('2w')">2W</th>
                                <th class="sortable" data-sort="1m" onclick="sortEliteTable('1m')">1M</th>
                                <th class="sortable" data-sort="3m" onclick="sortEliteTable('3m')">3M</th>
                                <th class="sortable" data-sort="6m" onclick="sortEliteTable('6m')">6M</th>
                                <th class="sortable" data-sort="9m" onclick="sortEliteTable('9m')">9M</th>
                                <th class="sortable" data-sort="1y" onclick="sortEliteTable('1y')">1Y</th>
                                <th class="sortable" data-sort="2y" onclick="sortEliteTable('2y')">2Y</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eliteTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                    <div id="eliteEmpty" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No elite strategies found. Run validation to identify consistent strategies.
                    </div>
                </div>

            </div>
        </div><!-- End elite-tab -->

        <!-- Autonomous Optimizer Tab Content -->
        <div id="autonomous-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon" style="background: linear-gradient(135deg, #f59e0b, #ef4444);">‚ö°</div>
                    <h2>Autonomous Optimizer</h2>

                    <!-- Toggle Switch -->
                    <label class="toggle-switch" style="margin-left: auto;">
                        <input type="checkbox" id="autonomousToggle" onchange="toggleAutonomousOptimizer()">
                        <span class="toggle-slider"></span>
                        <span id="autonomousToggleLabel" style="margin-left: 0.5rem; color: var(--text-secondary);">OFF</span>
                    </label>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>How it works:</strong> Automatically cycles through all trading pairs, timeframes, periods, and granularities running optimizations continuously.
                    Uses Capital: ¬£1000, Position Size: 100%. Pauses when you run manual optimizations.
                </div>

                <!-- Status Display -->
                <div id="autonomousStatus" class="autonomous-status-panel">
                    <div class="autonomous-status-bar">
                        <span id="autonomousStatusBadge" class="status-badge neutral">Idle</span>
                        <span id="autonomousStatusMessage" style="color: var(--text-secondary); margin-left: 1rem;">Not running</span>
                        <span id="autonomousCycleProgress" style="color: var(--text-muted); margin-left: auto; font-size: 0.85rem;"></span>
                    </div>

                    <!-- OVERALL PROGRESS BAR (never resets) -->
                    <div id="overallProgressContainer" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">OVERALL PROGRESS</span>
                            <span id="overallProgressText" style="font-size: 0.85rem; color: var(--text-primary); font-weight: 600;">0 / 0 (0%)</span>
                        </div>
                        <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div id="overallProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--success), #22d3ee); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>

                <!-- Task Queue -->
                <div class="task-queue" id="taskQueue">
                    <div class="task-queue-header">
                        <span>OPTIMIZATION QUEUE</span>
                    </div>
                    <div id="taskQueueBody">
                        <!-- Populated by JavaScript -->
                        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
                            Enable optimizer to see queue
                        </div>
                    </div>
                </div>

                <!-- Results Summary -->
                <div id="autonomousResultsSummary" style="margin-top: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary);">Session Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--success);" id="autoCompletedCount">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #f59e0b;" id="autoSkippedCount">0</div>
                            <div class="stat-label">Skipped</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--danger);" id="autoErrorCount">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="autoTotalCombinations">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="autoLastCompleted">-</div>
                            <div class="stat-label">Last Completed</div>
                        </div>
                    </div>
                </div>

                <!-- Best Strategy Found -->
                <div id="autoBestStrategySection" style="display: none; margin-top: 1.5rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success); border-radius: 8px;">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--success);">üèÜ Best Strategy Found</h3>
                    <div id="autoBestStrategyDetails" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Last Result -->
                <div id="autoLastResultSection" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--text-secondary);">Last Optimization Result</h4>
                    <div id="autoLastResultDetails">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Skipped Validations Log (Collapsible) -->
                <div id="autoSkippedSection" class="collapsible-section" style="display: none; margin-top: 1rem;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this.parentElement)">
                        <span>‚ö† Skipped - Insufficient Data (<span id="skippedCountLabel">0</span>)</span>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                            Combinations skipped due to insufficient historical data.
                        </p>
                        <div style="overflow-x: auto; max-height: 200px; overflow-y: auto;">
                            <table class="history-table" id="autoSkippedTable">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Pair</th>
                                        <th>Period</th>
                                        <th>Timeframe</th>
                                        <th>Coverage</th>
                                    </tr>
                                </thead>
                                <tbody id="autoSkippedTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Optimization History (Collapsible) -->
                <div id="autoHistorySection" class="collapsible-section" style="margin-top: 1rem;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this.parentElement)">
                        <span>üìú Optimization History</span>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div style="overflow-x: auto; max-height: 250px; overflow-y: auto;">
                            <table class="history-table" id="autoHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Pair</th>
                                        <th>Period</th>
                                        <th>Timeframe</th>
                                        <th>Strategies</th>
                                        <th>Best PnL</th>
                                    </tr>
                                </thead>
                                <tbody id="autoHistoryTableBody"></tbody>
                            </table>
                            <div id="autoHistoryEmpty" style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                                No history yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- End autonomous-tab -->

        <!-- Tools Tab -->
        <div id="tools-tab" class="tab-content" style="display: none;">
            <div class="card" style="width: 100%;">
                <div class="card-header">
                    <div class="icon">üîß</div>
                    <h2>Tools</h2>
                </div>
                <div class="card-body">
                    <!-- Priority Queue Manager (TOP) - New 3-Column Layout -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-secondary);">Priority Queue</h3>

                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Optimization Priority Order</h4>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Drag items within each list to set priority. The optimizer processes: Pair #1 + Period #1 + Timeframe #1 first, then cycles through.
                                Disable items to skip them.
                            </p>

                            <!-- 4-Column Priority Lists -->
                            <div class="priority-columns">
                                <!-- Trading Pairs Column -->
                                <div class="priority-column">
                                    <div class="priority-column-header">
                                        <span class="column-icon">üí±</span>
                                        <span class="column-title">Trading Pairs</span>
                                        <span class="column-count" id="pairsCount">0/0</span>
                                    </div>
                                    <div class="priority-list-container">
                                        <div id="pairsPriorityList" class="priority-list" data-list-type="pairs"></div>
                                    </div>
                                </div>

                                <!-- Historical Periods Column -->
                                <div class="priority-column">
                                    <div class="priority-column-header">
                                        <span class="column-icon">üìÖ</span>
                                        <span class="column-title">Historical Periods</span>
                                        <span class="column-count" id="periodsCount">0/0</span>
                                    </div>
                                    <div class="priority-list-container">
                                        <div id="periodsPriorityList" class="priority-list" data-list-type="periods"></div>
                                    </div>
                                </div>

                                <!-- Timeframes Column -->
                                <div class="priority-column">
                                    <div class="priority-column-header">
                                        <span class="column-icon">‚è±Ô∏è</span>
                                        <span class="column-title">Timeframes</span>
                                        <span class="column-count" id="timeframesCount">0/0</span>
                                    </div>
                                    <div class="priority-list-container">
                                        <div id="timeframesPriorityList" class="priority-list" data-list-type="timeframes"></div>
                                    </div>
                                </div>

                                <!-- Granularities Column -->
                                <div class="priority-column">
                                    <div class="priority-column-header">
                                        <span class="column-icon">üéØ</span>
                                        <span class="column-title">Granularity</span>
                                        <span class="column-count" id="granularitiesCount">0/0</span>
                                    </div>
                                    <div class="priority-list-container">
                                        <div id="granularitiesPriorityList" class="priority-list" data-list-type="granularities"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Row -->
                            <div class="priority-summary">
                                <div class="combo-count">
                                    Total combinations: <strong id="totalCombinations">0</strong>
                                </div>
                                <div style="margin-left: auto; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn btn-secondary btn-sm" onclick="enableAllPriorityItems()">
                                        ‚úÖ Enable All
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="disableAllPriorityItems()">
                                        ‚õî Disable All
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="resetPriorityToDefaults()">
                                        üîÑ Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Tools -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-secondary);">Database Management</h3>

                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Clear Database</h4>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Delete all data from the database. This will remove all strategies, optimization history,
                                completed optimization tracking, and priority queue settings. Use this to start completely fresh.
                            </p>
                            <p style="font-size: 0.85rem; color: var(--danger); margin-bottom: 1rem;">
                                ‚ö†Ô∏è This action cannot be undone!
                            </p>
                            <button class="btn btn-danger" onclick="clearDatabase()" style="background: var(--danger); color: white;">
                                üóëÔ∏è Clear Database
                            </button>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Database Statistics</h4>
                            <div id="dbStats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                                <div class="stat-item">
                                    <div class="stat-value" id="dbTotalStrategies">-</div>
                                    <div class="stat-label">Total Strategies</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="dbEliteStrategies">-</div>
                                    <div class="stat-label">Elite Strategies</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="dbPendingValidation">-</div>
                                    <div class="stat-label">Pending Validation</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="refreshDbStats()" style="margin-top: 1rem;">
                                üîÑ Refresh Stats
                            </button>
                        </div>
                    </div>

                    <!-- Elite Validation Tools -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-secondary);">Elite Validation</h3>

                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Reset Elite Validation</h4>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Reset all elite validation data. All strategies will be set to 'pending' and re-validated
                                with the current scoring system. Use this after updating the scoring algorithm.
                            </p>
                            <p style="font-size: 0.85rem; color: var(--warning); margin-bottom: 1rem;">
                                ‚ö†Ô∏è This will clear all existing elite scores and validation data.
                            </p>
                            <button class="btn btn-warning" onclick="resetEliteValidation()" style="background: var(--warning); color: #000;">
                                üîÑ Reset Elite Validation
                            </button>
                        </div>
                    </div>

                    <!-- Autonomous Optimizer Tools -->
                    <div>
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-secondary);">Autonomous Optimizer</h3>

                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Reset Cycle Position</h4>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Reset the autonomous optimizer to start from the beginning of the combination cycle.
                            </p>
                            <button class="btn btn-secondary" onclick="resetAutonomousCycle()">
                                üîÑ Reset Cycle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- End tools-tab -->
    </div>


    <!-- TradingView Embedded Chart Modal -->
    <div id="tv-chart-container" class="hidden">
        <div class="tv-chart-header">
            <h3>Strategy Visualization</h3>
            <button onclick="closeTVChart()" class="close-btn">&times;</button>
        </div>
        <div id="tv-chart-widget" style="height: 500px;"></div>
    </div>

    <!-- Modal Backdrop (for TradingView chart) -->
    <div id="tv-chart-backdrop" class="hidden" onclick="closeTVChart()"></div>

    <!-- Pine Script Modal -->
    <div id="pineScriptModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid var(--border);">
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="pineModalTitle" style="margin: 0; color: var(--text-primary);">Pine Script</h3>
                <button onclick="closePineModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 1rem 1.5rem; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <p style="color: var(--text-muted); margin: 0 0 0.75rem 0; font-size: 0.85rem;">Select all (Ctrl+A / Cmd+A) and copy (Ctrl+C / Cmd+C):</p>
                <textarea id="pineScriptContent" readonly style="flex: 1; width: 100%; min-height: 400px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 0.8rem; resize: none;"></textarea>
            </div>
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="selectAllPineScript()" class="btn btn-secondary" style="font-size: 0.85rem;">Select All</button>
                <button onclick="closePineModal()" class="btn" style="font-size: 0.85rem;">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Period Selection Modal -->
    <div id="exportPeriodModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); border-radius: 12px; width: 90%; max-width: 500px; display: flex; flex-direction: column; border: 1px solid var(--border);">
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="exportModalTitle" style="margin: 0; color: var(--text-primary);">Export Trades CSV</h3>
                <button onclick="closeExportModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <p style="color: var(--text-muted); margin: 0 0 1rem 0; font-size: 0.9rem;">Select period(s) to export:</p>
                <div id="exportPeriodOptions" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <!-- Populated dynamically -->
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--text-primary);">
                        <input type="checkbox" id="exportSelectAll" onchange="toggleExportSelectAll()" style="width: 18px; height: 18px;">
                        <span>Select All (download as separate files)</span>
                    </label>
                </div>
            </div>
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="closeExportModal()" class="btn btn-secondary" style="font-size: 0.85rem;">Cancel</button>
                <button onclick="executeExport()" class="btn" style="font-size: 0.85rem;">Export Selected</button>
            </div>
        </div>
    </div>

    <!-- Advanced Strategy Debugger Modal -->
    <div id="debugModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 2rem 0;">
        <div style="background: var(--bg-card); border-radius: 12px; width: 95%; max-width: 1200px; display: flex; flex-direction: column; border: 1px solid var(--border); margin: auto;">
            <!-- Header -->
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));">
                <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">üêõ</span> Advanced Strategy Debugger
                </h3>
                <button onclick="closeDebugModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>

            <!-- Strategy Info Section -->
            <div id="debugStrategyInfo" style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Strategy:</span>
                        <span id="debugStrategyName" style="color: var(--text-primary); font-weight: 600;"></span>
                    </div>
                    <span id="debugDirectionBadge" style="padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;"></span>
                    <span id="debugDataPeriod" style="padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: rgba(99, 102, 241, 0.2); color: #a5b4fc;"></span>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-left: auto;">
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">TP%</div>
                            <div id="debugTP" style="color: var(--success); font-weight: 600;"></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">SL%</div>
                            <div id="debugSL" style="color: var(--danger); font-weight: 600;"></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Win Rate</div>
                            <div id="debugWinRate" style="color: var(--text-primary); font-weight: 600;"></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">PF</div>
                            <div id="debugPF" style="color: var(--text-primary); font-weight: 600;"></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Trades</div>
                            <div id="debugTrades" style="color: var(--text-primary); font-weight: 600;"></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Total P&L</div>
                            <div id="debugTotalPnL" style="color: var(--success); font-weight: 600;"></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Max DD</div>
                            <div id="debugMaxDD" style="color: var(--danger); font-weight: 600;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entry Rule Validation Warning (populated by JS if entry_rule is invalid) -->
            <div id="debugEntryRuleWarning" style="display: none; padding: 0 1.5rem;"></div>

            <!-- Main Content -->
            <div style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; max-height: 70vh; overflow-y: auto;">

                <!-- Pine Script Section (buttons only, no preview) -->
                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìú</span> Pine Script
                        </h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="copyDebugPineScript()" class="btn btn-small" style="font-size: 0.8rem;">üìã Copy</button>
                            <button onclick="downloadDebugPineScript()" class="btn btn-small" style="font-size: 0.8rem;">‚¨áÔ∏è Download</button>
                            <button onclick="openDebugInTradingView()" class="btn btn-small" style="font-size: 0.8rem; background: linear-gradient(135deg, #2962FF, #00BCD4);">üìà Open in TradingView</button>
                        </div>
                    </div>
                    <!-- Hidden element to store Pine Script content -->
                    <pre id="debugPineScript" style="display: none;"></pre>
                </div>

                <!-- Our Trades Section -->
                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìä</span> Our Backtest Trades (<span id="debugOurTradeCount">0</span>)
                        </h4>
                        <button onclick="exportDebugTrades()" class="btn btn-small" style="font-size: 0.8rem;">‚¨áÔ∏è Export CSV</button>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto; border-radius: 4px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead style="position: sticky; top: 0; background: var(--bg-primary);">
                                <tr>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted);">#</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted);">Dir</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted);">Entry Time</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted);">Exit Time</th>
                                    <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border); color: var(--text-muted);">Entry $</th>
                                    <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border); color: var(--text-muted);">Exit $</th>
                                    <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border); color: var(--text-muted);">PnL</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted);">Result</th>
                                </tr>
                            </thead>
                            <tbody id="debugOurTradesBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TradingView Upload Section -->
                <div style="background: linear-gradient(135deg, rgba(41, 98, 255, 0.1), rgba(0, 188, 212, 0.1)); border-radius: 8px; padding: 1rem; border: 1px solid rgba(41, 98, 255, 0.3);">
                    <h4 style="margin: 0 0 0.75rem 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <span>üì∫</span> TradingView Trades
                    </h4>
                    <div style="background: var(--bg-card); border-radius: 8px; padding: 1.5rem; text-align: center; border: 2px dashed var(--border);">
                        <p style="color: var(--text-muted); margin: 0 0 1rem 0; font-size: 0.85rem;">
                            In TradingView Strategy Tester, click <strong>"List of Trades"</strong> ‚Üí <strong>Export (CSV icon)</strong>
                        </p>
                        <input type="file" id="debugTVUpload" accept=".csv" onchange="uploadDebugTVTrades(event)" style="display: none;">
                        <button onclick="document.getElementById('debugTVUpload').click()" class="btn" style="background: linear-gradient(135deg, #2962FF, #00BCD4);">
                            üìÅ Upload TradingView Trade Export
                        </button>
                    </div>
                </div>

                <!-- Comparison Results Section (hidden until upload) -->
                <div id="debugResultsSection" style="display: none;">
                    <!-- Summary -->
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: var(--text-primary);">üìä Comparison Summary</h4>
                        <div id="debugSummary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;"></div>
                    </div>

                    <!-- Root Causes -->
                    <div id="debugRootCausesSection" style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: var(--text-primary);">üîç Root Cause Analysis</h4>
                        <div id="debugRootCauses"></div>
                    </div>

                    <!-- Recommendations -->
                    <div id="debugRecommendationsSection" style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: var(--text-primary);">üí° Recommendations</h4>
                        <div id="debugRecommendations"></div>
                    </div>

                    <!-- Trade Comparison Table -->
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                            <h4 style="margin: 0; color: var(--text-primary);">üìä Trade-by-Trade Comparison</h4>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <label style="color: var(--text-muted); font-size: 0.8rem;">
                                    Time Tolerance:
                                    <select id="debugTimeTolerance" onchange="updateTradeComparison()" style="margin-left: 0.25rem; padding: 0.2rem 0.4rem; font-size: 0.8rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);">
                                        <option value="5">5 min</option>
                                        <option value="15">15 min</option>
                                        <option value="30" selected>30 min</option>
                                        <option value="60">1 hour</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </label>
                                <label style="color: var(--text-muted); font-size: 0.8rem;">
                                    PnL Tolerance:
                                    <select id="debugPnlTolerance" onchange="updateTradeComparison()" style="margin-left: 0.25rem; padding: 0.2rem 0.4rem; font-size: 0.8rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);">
                                        <option value="1">¬£1</option>
                                        <option value="2" selected>¬£2</option>
                                        <option value="5">¬£5</option>
                                        <option value="10">¬£10</option>
                                        <option value="0">Any</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                        <!-- Match Summary Badges -->
                        <div id="debugMatchCounts" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem;"></div>

                        <!-- Side-by-Side Comparison Table -->
                        <div id="debugTradeComparison" style="overflow-x: auto;"></div>

                        <!-- Pagination Controls -->
                        <div id="debugPagination" style="display: none; margin-top: 0.75rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <span id="debugPageInfo" style="color: var(--text-muted); font-size: 0.8rem;"></span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="debugPrevPage" onclick="debugChangePage(-1)" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">‚Üê Previous</button>
                                <button id="debugNextPage" onclick="debugChangePage(1)" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Next ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="closeDebugModal()" class="btn btn-secondary" style="font-size: 0.85rem;">Close</button>
            </div>
        </div>
    </div>


    <!-- TradingView Charting Library (must be installed separately) -->
    <!-- NOTE: Download TradingView Charting Library from https://www.tradingview.com/HTML5-stock-forex-bitcoin-charting-library/ -->
    <!-- and place files in /frontend/charting_library/ directory -->
    <script src="/static/charting_library/charting_library.standalone.js"></script>
    <script src="/static/charting_library/datafeeds/udf/dist/bundle.js"></script>

    <script src="/static/js/tradingview-embed.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
