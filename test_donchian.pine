//@version=6
// CRITICAL: Use fixed quantity in base currency, not percent of equity
// This avoids TradingView's margin simulation entirely
strategy("Test Donchian Short", overlay=true, process_orders_on_close=true,
         default_qty_type=strategy.cash, default_qty_value=1000,
         initial_capital=100000, commission_type=strategy.commission.percent,
         commission_value=0.1, pyramiding=0, currency=currency.NONE,
         calc_on_every_tick=false)

// Donchian Channel (excluding current bar)
dcUpper = ta.highest(high, 20)[1]
dcLower = ta.lowest(low, 20)[1]

// Short signal: crossunder - price breaks below lower channel
shortSignal = close < dcLower and close[1] >= dcLower[1]

// Entry: only when flat
if shortSignal and strategy.position_size == 0
    strategy.entry("Short", strategy.short)

// Exit: percentage-based SL/TP
if strategy.position_size < 0
    tp = strategy.position_avg_price * (1 - 3.1/100)
    sl = strategy.position_avg_price * (1 + 4.6/100)
    strategy.exit("Exit", "Short", limit=tp, stop=sl)
